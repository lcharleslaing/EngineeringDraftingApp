{% extends 'base.html' %}
{% block title %}Edit: {{ process.name }}{% endblock %}
{% block content %}
<div class="sticky top-0 z-10 bg-base-100/90 backdrop-blur border-b border-base-200 mb-6">
  <div class="max-w-7xl mx-auto px-1 sm:px-2 lg:px-4 py-3">
    <div class="flex items-center gap-3 mb-3">
      <input id="process-name" class="input input-bordered w-full" value="{{ process.name }}" placeholder="Process name" required />
      <button id="stats-btn" class="btn btn-info btn-sm" data-process-id="{{ process.id }}">Stats</button>
    </div>
    <div class="flex items-center gap-2">
      <label class="flex items-center gap-2">
        <input id="toggle-images" type="checkbox" class="toggle toggle-primary" checked />
        <span class="text-sm">Show images</span>
      </label>
      <div class="ml-auto flex gap-2">
        <a class="btn btn-outline btn-sm" href="{% url 'process_creator:list' %}">Back</a>
        <a class="btn btn-outline btn-sm" href="{% url 'process_creator:print' process.id %}" target="_blank">Print</a>
        <button id="copy-btn" class="btn btn-primary btn-sm" data-copy-url="{% url 'process_creator:copy' process.id %}">Copy</button>
        <a id="pdf-btn" class="btn btn-secondary btn-sm" href="{% url 'process_creator:pdf' process.id %}" download>Save PDF</a>
        <a id="word-btn" class="btn btn-accent btn-sm" href="{% url 'process_creator:word' process.id %}" download>Save Word</a>
      </div>
    </div>
  </div>
</div>

<div class="max-w-7xl mx-auto px-1 sm:px-2 lg:px-4">
  <div class="grid grid-cols-12 gap-6">
    <div class="col-span-12">
      <div class="card bg-base-200 shadow-sm">
        <div class="card-body p-4">
          <div class="flex items-center justify-between mb-4">
            <h2 class="font-semibold text-lg">üìù Process Summary</h2>
            <button id="create-summary-btn" class="btn btn-primary btn-sm" data-process-id="{{ process.id }}">
              <i class="fas fa-robot mr-1"></i>Create Summary
            </button>
          </div>
          
          <div class="mb-4">
            <label class="label">
              <span class="label-text font-medium">Summary Instructions</span>
            </label>
            <textarea id="summary-instructions" class="textarea textarea-bordered w-full min-h-20" placeholder="Instructions for AI summary generation">{{ process.summary_instructions }}</textarea>
          </div>
          
          <div>
            <label class="label">
              <span class="label-text font-medium">Summary</span>
            </label>
            <textarea id="process-summary" class="textarea textarea-bordered w-full min-h-24" placeholder="AI-generated summary of the process">{{ process.summary }}</textarea>
          </div>
        </div>
      </div>
    </div>

    <div class="col-span-12">
      <h2 class="font-semibold mb-2">Description</h2>
      <textarea id="process-description" class="textarea textarea-bordered w-full min-h-28" placeholder="Describe the process">{{ process.description }}</textarea>
    </div>

    <div class="col-span-12">
      <div class="flex items-center justify-between mb-2">
        <h2 class="font-semibold">Steps</h2>
        <button id="add-step" class="btn btn-primary btn-sm">Add step</button>
      </div>
      <div id="steps" class="space-y-3">
        {% for step in process.steps.all %}
          <div class="card bg-base-200 shadow-sm" data-id="{{ step.id }}">
            <div class="card-body p-4">
              <div class="flex items-center gap-3">
                <span class="drag cursor-grab text-base-300" title="Drag to reorder">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M10 4h4v2h-4V4zm0 14h4v2h-4v-2zM4 10h2v4H4v-4zm14 0h2v4h-2v-4z"/></svg>
                </span>
                <input class="step-title input input-sm input-bordered flex-1" value="{{ step.title }}" required />
                <div class="flex gap-1">
                  <button class="btn btn-sm" data-insert="up" title="Add before">+ ‚òùÔ∏è</button>
                  <button class="btn btn-sm" data-insert="down" title="Add after">+ üëá</button>
                  <button class="btn btn-sm btn-error step-delete">Delete</button>
                </div>
              </div>
              <textarea class="step-details textarea textarea-bordered mt-3 h-24" placeholder="Details">{{ step.details }}</textarea>
              <div class="mt-3 img-section">
                <div class="text-sm opacity-70 mb-1">Screenshots (paste or drop images)</div>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-2" id="imgs-{{ step.id }}">
                  {% for img in step.images.all %}
                    <div class="relative group">
                      <img src="{{ img.image.url }}" class="rounded border object-cover w-full h-28" />
                      <button class="btn btn-xs btn-error absolute top-1 right-1 opacity-0 group-hover:opacity-100 delete-img" data-step="{{ step.id }}" data-id="{{ img.id }}">‚úï</button>
                    </div>
                  {% endfor %}
                </div>
                <div class="mt-2 flex gap-2">
                  <button type="button" class="btn btn-sm" data-open-upload="{{ step.id }}">Add images</button>
                  <input type="file" accept="image/*" multiple class="hidden" data-upload-step="{{ step.id }}" />
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>

    <div class="col-span-12">
      <h2 class="font-semibold mb-2">Notes</h2>
      <textarea id="process-notes" class="textarea textarea-bordered w-full min-h-40" placeholder="Any notes">{{ process.notes }}</textarea>
    </div>

    <div class="col-span-12">
      <div class="card bg-base-200 shadow-sm">
        <div class="card-body p-4">
          <div class="flex items-center justify-between mb-4">
            <h2 class="font-semibold text-lg">üìä Process Analysis</h2>
            <button id="analyze-btn" class="btn btn-accent btn-sm" data-process-id="{{ process.id }}">
              <i class="fas fa-brain mr-1"></i>Analyze Process
            </button>
          </div>
          
          <div class="mb-4">
            <label class="label">
              <span class="label-text font-medium">Analysis Instructions</span>
            </label>
            <textarea id="analysis-instructions" class="textarea textarea-bordered w-full min-h-32" placeholder="Instructions for AI analysis">{{ process.analysis_instructions }}</textarea>
          </div>
          
          <div>
            <label class="label">
              <span class="label-text font-medium">Analysis Results</span>
            </label>
            <textarea id="process-analysis" class="textarea textarea-bordered w-full min-h-40" placeholder="AI-generated analysis and improvement suggestions">{{ process.analysis }}</textarea>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Stats Modal -->
<dialog id="stats-modal" class="modal">
  <div class="modal-box w-11/12 max-w-2xl">
    <div class="flex items-center justify-between mb-6">
      <h3 class="font-bold text-2xl text-primary">üìä Process Statistics</h3>
      <button class="btn btn-sm btn-circle btn-ghost" onclick="document.getElementById('stats-modal').close()">‚úï</button>
    </div>
    <div id="stats-content" class="space-y-4">
      <!-- Stats will be loaded here -->
    </div>
  </div>
</dialog>

<!-- Image Viewer Modal -->
<dialog id="image-modal" class="modal">
  <div class="modal-box w-11/12 max-w-4xl p-0">
    <div class="flex items-center justify-between p-4 border-b">
      <h3 class="font-bold text-lg">Image Viewer</h3>
      <button class="btn btn-sm btn-circle btn-ghost" onclick="document.getElementById('image-modal').close()">‚úï</button>
    </div>
    <div class="p-4">
      <img id="modal-image" src="" alt="Full size image" class="w-full h-auto max-h-[70vh] object-contain mx-auto" />
    </div>
  </div>
</dialog>

{% endblock %}

{% block extra_js %}
<script>
const processId = {{ process.id }};
const base = '/process-creator/' + processId + '/';

async function post(url, data){
  const form = new URLSearchParams();
  for(const [k,v] of Object.entries(data||{})) form.append(k,v);
  const res = await fetch(url, {method:'POST', headers:{'X-CSRFToken': getCookie('csrftoken')}, body:form});
  return res.json();
}

function getCookie(name){
  const value = `; ${document.cookie}`.split(`; ${name}=`).pop();
  return value ? value.split(';').shift() : '';
}

// Track if process has been updated since last AI interaction
let processUpdated = false;

// Autosave process fields
function debouncedSave(){
  clearTimeout(window._saveT); window._saveT = setTimeout(() => {
    post(base + 'update/', {
      description: document.getElementById('process-description').value,
      notes: document.getElementById('process-notes').value,
      summary: document.getElementById('process-summary').value,
      summary_instructions: document.getElementById('summary-instructions').value,
      analysis: document.getElementById('process-analysis').value,
      analysis_instructions: document.getElementById('analysis-instructions').value,
    }).then(() => {
      processUpdated = true;
    });
  }, 400);
}

document.getElementById('process-description').addEventListener('input', debouncedSave);
document.getElementById('process-notes').addEventListener('input', debouncedSave);
document.getElementById('process-summary').addEventListener('input', debouncedSave);
document.getElementById('summary-instructions').addEventListener('input', debouncedSave);
document.getElementById('process-analysis').addEventListener('input', debouncedSave);
document.getElementById('analysis-instructions').addEventListener('input', debouncedSave);

// Name change via simple submit to update endpoint
document.getElementById('process-name').addEventListener('change', async (e)=>{
  await fetch(base + 'update/', {method:'POST', headers:{'X-CSRFToken': getCookie('csrftoken')}, body:new URLSearchParams({name:e.target.value})});
});

// Add step
document.getElementById('add-step').addEventListener('click', async ()=>{
  const data = await post(base + 'steps/add/', {title:'New Step'});
  location.reload();
});

// Update step fields
document.querySelectorAll('#steps .card').forEach(card=>{
  const id = card.dataset.id;
  card.querySelector('.step-title').addEventListener('change', e=>{
    post(base + 'steps/' + id + '/update/', {title:e.target.value});
  });
  card.querySelector('.step-details').addEventListener('input', ()=>{
    clearTimeout(card._t); card._t = setTimeout(()=>{
      post(base + 'steps/' + id + '/update/', {details:card.querySelector('.step-details').value});
    }, 400);
  });
  card.querySelector('.step-delete').addEventListener('click', ()=>{
    post(base + 'steps/' + id + '/delete/').then(()=>location.reload());
  });
});

// Drag and drop ordering
let dragEl = null;
document.querySelectorAll('#steps .card .drag').forEach(handle=>{
  const card = handle.closest('.card');
  card.draggable = true;
  card.addEventListener('dragstart', ()=>{ dragEl = card; card.classList.add('opacity-50'); });
  card.addEventListener('dragend', ()=>{ card.classList.remove('opacity-50'); dragEl = null; saveOrder(); });
});

document.getElementById('steps').addEventListener('dragover', (e)=>{
  e.preventDefault();
  const container = e.currentTarget;
  const afterEl = Array.from(container.querySelectorAll('.card')).find(el=>{
    const rect = el.getBoundingClientRect();
    return e.clientY < rect.top + rect.height/2;
  });
  if (!afterEl) container.appendChild(dragEl); else container.insertBefore(dragEl, afterEl);
});

function saveOrder(){
  const ids = Array.from(document.querySelectorAll('#steps .card')).map(c=>c.dataset.id);
  const form = new URLSearchParams(); ids.forEach(id=>form.append('order[]', id));
  fetch(base + 'steps/reorder/', {method:'POST', headers:{'X-CSRFToken': getCookie('csrftoken')}, body:form});
}

// Copy markdown to clipboard
document.getElementById('copy-btn').addEventListener('click', async (e)=>{
  e.preventDefault();
  const url = e.currentTarget.dataset.copyUrl;
  try {
    const res = await fetch(url);
    const text = await res.text();
    await navigator.clipboard.writeText(text);
    const toast = document.createElement('div');
    toast.className = 'toast toast-top toast-end';
    toast.innerHTML = '<div class="alert alert-success"><span>Copied Markdown to clipboard.</span></div>';
    document.body.appendChild(toast);
    setTimeout(()=>toast.remove(), 1500);
  } catch(err) {
    const toast = document.createElement('div');
    toast.className = 'toast toast-top toast-end';
    toast.innerHTML = '<div class="alert alert-error"><span>Copy failed.</span></div>';
    document.body.appendChild(toast);
    setTimeout(()=>toast.remove(), 2000);
  }
});


// Image uploads via file input
document.querySelectorAll('input[data-upload-step]').forEach(input=>{
  input.addEventListener('change', async (e)=>{
    const stepId = e.currentTarget.getAttribute('data-upload-step');
    for (const file of e.currentTarget.files) {
      const fd = new FormData(); fd.append('image', file);
      const res = await fetch(base + 'steps/' + stepId + '/images/upload/', {method:'POST', headers:{'X-CSRFToken': getCookie('csrftoken')}, body: fd});
      const data = await res.json(); if (data.ok) addThumb(stepId, data);
    }
    e.currentTarget.value = '';
  });
});

// Dedicated button opens file input
document.querySelectorAll('[data-open-upload]').forEach(btn=>{
  btn.addEventListener('click', (e)=>{
    e.preventDefault();
    const stepId = e.currentTarget.getAttribute('data-open-upload');
    const input = document.querySelector(`input[data-upload-step="${stepId}"]`);
    if (input) input.click();
  });
});

// Master toggle show/hide images (display only; print unaffected)
const imgToggle = document.getElementById('toggle-images');
const TOGGLE_KEY = 'process_creator_show_images';
function applyImageVisibility(){
  const show = imgToggle.checked;
  document.querySelectorAll('.img-section').forEach(sec=>{
    sec.style.display = show ? '' : 'none';
  });
  try { localStorage.setItem(TOGGLE_KEY, show ? '1' : '0'); } catch(e) {}
}
// Initialize from localStorage (default: show)
try {
  const saved = localStorage.getItem(TOGGLE_KEY);
  if (saved === '0') imgToggle.checked = false;
} catch(e) {}
imgToggle.addEventListener('change', applyImageVisibility);
// Apply once on load
applyImageVisibility();

// Stats modal functionality
document.getElementById('stats-btn').addEventListener('click', async (e)=>{
  e.preventDefault();
  const modal = document.getElementById('stats-modal');
  const content = document.getElementById('stats-content');
  
  try {
    const res = await fetch(`/process-creator/${processId}/stats/`);
    const data = await res.json();
    
    content.innerHTML = `
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Timeline Section -->
        <div class="card bg-base-200 shadow-sm">
          <div class="card-body p-4">
            <h4 class="card-title text-lg text-primary mb-4">üìÖ Timeline</h4>
            <div class="space-y-3">
              <div class="flex items-center gap-3">
                <div class="badge badge-primary badge-sm">Created</div>
                <div class="text-sm font-medium">${data.created_at}</div>
              </div>
              <div class="flex items-center gap-3">
                <div class="badge badge-secondary badge-sm">Updated</div>
                <div class="text-sm font-medium">${data.updated_at}</div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Content Stats -->
        <div class="card bg-base-200 shadow-sm">
          <div class="card-body p-4">
            <h4 class="card-title text-lg text-accent mb-4">üìù Content</h4>
            <div class="space-y-3">
              <div class="flex justify-between items-center">
                <span class="text-sm opacity-70">Steps</span>
                <div class="badge badge-accent badge-lg">${data.step_count}</div>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-sm opacity-70">Images</span>
                <div class="badge badge-accent badge-lg">${data.image_count}</div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Text Stats -->
        <div class="card bg-base-200 shadow-sm">
          <div class="card-body p-4">
            <h4 class="card-title text-lg text-info mb-4">üìÑ Text Content</h4>
            <div class="space-y-3">
              <div class="flex justify-between items-center">
                <span class="text-sm opacity-70">Description</span>
                <div class="text-sm font-medium">${data.description_length} chars</div>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-sm opacity-70">Notes</span>
                <div class="text-sm font-medium">${data.notes_length} chars</div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Summary Stats -->
        <div class="card bg-gradient-to-br from-primary to-secondary text-primary-content shadow-lg">
          <div class="card-body p-4">
            <h4 class="card-title text-lg mb-4">üéØ Summary</h4>
            <div class="space-y-2">
              <div class="flex justify-between">
                <span class="text-sm opacity-90">Total Content</span>
                <span class="font-bold">${data.step_count + data.image_count} items</span>
              </div>
              <div class="flex justify-between">
                <span class="text-sm opacity-90">Text Length</span>
                <span class="font-bold">${data.description_length + data.notes_length} chars</span>
              </div>
              <div class="divider my-2"></div>
              <div class="text-center">
                <div class="text-2xl font-bold">${data.step_count > 0 ? Math.round(data.image_count / data.step_count * 10) / 10 : 0}</div>
                <div class="text-sm opacity-90">images per step</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
    
    modal.showModal();
  } catch(err) {
    content.innerHTML = `
      <div class="alert alert-error">
        <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <span>Failed to load statistics. Please try again.</span>
      </div>
    `;
    modal.showModal();
  }
});

// AI Create Summary
document.getElementById('create-summary-btn').addEventListener('click', async (e)=>{
  e.preventDefault();
  const btn = e.target;
  const originalText = btn.innerHTML;
  
  try {
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Creating...';
    
    const instructions = document.getElementById('summary-instructions').value;
    const res = await fetch(`/process-creator/${processId}/ai/summary/`, {
      method: 'POST',
      headers: {'X-CSRFToken': getCookie('csrftoken'), 'Content-Type': 'application/json'},
      body: JSON.stringify({instructions: instructions})
    });
    
    if (!res.ok) {
      throw new Error(`HTTP error! status: ${res.status}`);
    }
    
    const data = await res.json();
    if (data.success) {
      document.getElementById('process-summary').value = data.summary;
      
      // Show success toast
      const toast = document.createElement('div');
      toast.className = 'toast toast-top toast-end';
      toast.innerHTML = '<div class="alert alert-success"><span>Process summary created successfully!</span></div>';
      document.body.appendChild(toast);
      setTimeout(()=>toast.remove(), 3000);
    } else {
      throw new Error(data.error || 'Failed to generate process summary');
    }
  } catch(err) {
    const toast = document.createElement('div');
    toast.className = 'toast toast-top toast-end';
    toast.innerHTML = '<div class="alert alert-error"><span>Failed to create process summary: ' + err.message + '</span></div>';
    document.body.appendChild(toast);
    setTimeout(()=>toast.remove(), 5000);
  } finally {
    btn.disabled = false;
    btn.innerHTML = originalText;
  }
});

// AI Analysis
document.getElementById('analyze-btn').addEventListener('click', async (e)=>{
  e.preventDefault();
  const btn = e.target;
  const originalText = btn.innerHTML;
  
  try {
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Analyzing...';
    
    const instructions = document.getElementById('analysis-instructions').value;
    const res = await fetch(`/process-creator/${processId}/ai/analyze/`, {
      method: 'POST',
      headers: {'X-CSRFToken': getCookie('csrftoken'), 'Content-Type': 'application/json'},
      body: JSON.stringify({instructions: instructions})
    });
    
    if (!res.ok) {
      throw new Error(`HTTP error! status: ${res.status}`);
    }
    
    const data = await res.json();
    if (data.success) {
      document.getElementById('process-analysis').value = data.analysis;
      
      // Show success toast
      const toast = document.createElement('div');
      toast.className = 'toast toast-top toast-end';
      toast.innerHTML = '<div class="alert alert-success"><span>Process analysis completed successfully!</span></div>';
      document.body.appendChild(toast);
      setTimeout(()=>toast.remove(), 3000);
    } else {
      throw new Error(data.error || 'Failed to generate analysis');
    }
  } catch(err) {
    const toast = document.createElement('div');
    toast.className = 'toast toast-top toast-end';
    toast.innerHTML = '<div class="alert alert-error"><span>Failed to generate process analysis: ' + err.message + '</span></div>';
    document.body.appendChild(toast);
    setTimeout(()=>toast.remove(), 5000);
  } finally {
    btn.disabled = false;
    btn.innerHTML = originalText;
  }
});

// Image click handler - open images in modal
document.addEventListener('click', (e) => {
  // Check if clicked element is an image within a step
  if (e.target.tagName === 'IMG' && e.target.closest('[id^="imgs-"]')) {
    e.preventDefault();
    const imgSrc = e.target.src;
    const modal = document.getElementById('image-modal');
    const modalImg = document.getElementById('modal-image');
    
    modalImg.src = imgSrc;
    modal.showModal();
  }
});

// Image grid click handler removed - only "Add images" button opens file dialog

// Paste handler on window - attach to nearest focused step card
window.addEventListener('paste', async (e)=>{
  const items = e.clipboardData && e.clipboardData.items; if (!items) return;
  let file = null; for (const it of items) { if (it.type.indexOf('image') !== -1) { file = it.getAsFile(); break; } }
  if (!file) return;
  // find focused step
  const active = document.activeElement.closest('.card');
  if (!active) return;
  const stepId = active.dataset.id;
  const fd = new FormData(); fd.append('file', file);
  const res = await fetch(base + 'steps/' + stepId + '/images/upload/', {method:'POST', headers:{'X-CSRFToken': getCookie('csrftoken')}, body: fd});
  const data = await res.json(); if (data.ok) addThumb(stepId, data);
});

// Delete image - use event delegation for all images
document.addEventListener('click', async (e)=>{
  const deleteBtn = e.target.closest('.delete-img');
  if (!deleteBtn) return;
  
  e.preventDefault();
  e.stopPropagation();
  
  const stepId = deleteBtn.getAttribute('data-step');
  const id = deleteBtn.getAttribute('data-id');
  
  try {
    await fetch(base + 'steps/' + stepId + '/images/' + id + '/delete/', {
      method:'POST', 
      headers:{'X-CSRFToken': getCookie('csrftoken')}
    });
    deleteBtn.closest('.relative').remove();
  } catch(err) {
    console.error('Failed to delete image:', err);
  }
});

function addThumb(stepId, data){
  const container = document.getElementById('imgs-'+stepId);
  const div = document.createElement('div');
  div.className = 'relative group';
  div.innerHTML = `<img src="${data.url}" class="rounded border object-cover w-full h-28" /><button class="btn btn-xs btn-error absolute top-1 right-1 opacity-0 group-hover:opacity-100 delete-img" data-step="${stepId}" data-id="${data.id}">‚úï</button>`;
  container.appendChild(div);
  // Event listener is now handled by event delegation above
}

// Insert step before/after with event delegation (more reliable)
document.getElementById('steps').addEventListener('click', async (e)=>{
  const btn = e.target.closest('button[data-insert]');
  if (!btn) return;
  e.preventDefault();
  const card = btn.closest('.card');
  if (!card) return;
  const id = card.dataset.id;
  const dir = btn.getAttribute('data-insert');
  try {
    btn.disabled = true;
    const res = await fetch(base + 'steps/' + id + '/insert/' + dir + '/', {method:'POST', headers:{'X-CSRFToken': getCookie('csrftoken')}});
    const data = await res.json();
    if (data && data.ok) {
      location.reload();
    } else {
      btn.disabled = false;
    }
  } catch(err) {
    btn.disabled = false;
  }
});
</script>
{% endblock %}


