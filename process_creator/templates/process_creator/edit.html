{% extends 'base.html' %}
{% load process_filters %}
{% block title %}Edit: {{ process.name }}{% endblock %}
{% block content %}
<div class="sticky top-0 z-10 bg-base-100/90 backdrop-blur border-b border-base-200 mb-6">
  <div class="max-w-7xl mx-auto px-1 sm:px-2 lg:px-4 py-3">
    <div class="flex items-center gap-3 mb-3">
      <input id="process-name" class="input input-bordered w-full" value="{{ process.name }}" placeholder="Process name" required />
      <select id="process-module" class="select select-bordered w-full max-w-xs">
        <option value="">No Module</option>
        {% for module in modules %}
          <option value="{{ module.id }}" {% if process.module and process.module.id == module.id %}selected{% endif %}>
            {{ module.name }}
          </option>
        {% endfor %}
        <option value="__new__">+ New Module‚Ä¶</option>
      </select>
      <button id="stats-btn" class="btn btn-info btn-sm" data-process-id="{{ process.id }}">Stats</button>
    </div>
    <div class="flex items-center gap-2">
      <label class="flex items-center gap-2">
        <input id="toggle-images" type="checkbox" class="toggle toggle-primary" checked />
        <span class="text-sm">Show Attachments</span>
      </label>
      <div class="ml-auto flex gap-2">
        <a class="btn btn-outline btn-sm" href="{% url 'process_creator:list' %}">Back</a>
        <a class="btn btn-outline btn-sm" href="{% url 'process_creator:print' process.id %}" target="_blank">Print</a>
        <button id="copy-btn" class="btn btn-primary btn-sm" data-copy-url="{% url 'process_creator:copy' process.id %}">Copy</button>
        <a id="pdf-btn" class="btn btn-secondary btn-sm" href="{% url 'process_creator:pdf' process.id %}" download>Save PDF</a>
        <a id="word-btn" class="btn btn-accent btn-sm" href="{% url 'process_creator:word' process.id %}" download>Save Word</a>
      </div>
    </div>
  </div>
</div>

<div class="max-w-7xl mx-auto px-1 sm:px-2 lg:px-4">
  <div class="grid grid-cols-12 gap-6">
    <div class="col-span-12">
      <div class="card bg-base-200 shadow-sm">
        <div class="card-body p-4">
          <div class="flex items-center justify-between mb-4">
            <h2 class="font-semibold text-lg">üìù Process Summary</h2>
            <button id="create-summary-btn" class="btn btn-primary btn-sm" data-process-id="{{ process.id }}">
              <i class="fas fa-robot mr-1"></i>Create Summary
            </button>
          </div>
          
          <div class="mb-4">
            <label class="label">
              <span class="label-text font-medium">Summary Instructions</span>
            </label>
            <textarea id="summary-instructions" class="textarea textarea-bordered w-full min-h-20" placeholder="Instructions for AI summary generation">{{ process.summary_instructions }}</textarea>
          </div>
          
          <div>
            <label class="label">
              <span class="label-text font-medium">Summary</span>
            </label>
            <textarea id="process-summary" class="textarea textarea-bordered w-full min-h-24" placeholder="AI-generated summary of the process">{{ process.summary }}</textarea>
          </div>
        </div>
      </div>
    </div>

    <div class="col-span-12">
      <h2 class="font-semibold mb-2">Description</h2>
      <textarea id="process-description" class="textarea textarea-bordered w-full min-h-28" placeholder="Describe the process">{{ process.description }}</textarea>
    </div>

    <div class="col-span-12">
      <div class="flex items-center justify-between mb-2">
        <h2 class="font-semibold">Steps</h2>
        <button id="add-step" class="btn btn-primary btn-sm">Add step</button>
      </div>
      <div id="steps" class="space-y-3">
        {% for step in process.steps.all %}
          <div class="card bg-base-200 shadow-sm" data-id="{{ step.id }}">
            <div class="card-body p-4">
              <div class="flex items-center gap-3">
                <span class="drag cursor-grab text-base-300" title="Drag to reorder">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M10 4h4v2h-4V4zm0 14h4v2h-4v-2zM4 10h2v4H4v-4zm14 0h2v4h-2v-4z"/></svg>
                </span>
                <input class="step-title input input-sm input-bordered flex-1" value="{{ step.title }}" required />
                <div class="flex gap-1">
                  <button class="btn btn-sm" data-insert="up" title="Add before">+ ‚òùÔ∏è</button>
                  <button class="btn btn-sm" data-insert="down" title="Add after">+ üëá</button>
                  <button class="btn btn-sm btn-error step-delete">Delete</button>
                </div>
              </div>
              <textarea class="step-details textarea textarea-bordered mt-3 h-24" placeholder="Details">{{ step.details }}</textarea>
              <!-- Links -->
              <div class="mt-3">
                <div class="text-sm opacity-70 mb-1">Links</div>
                <div class="flex flex-wrap gap-2" id="links-{{ step.id }}">
                  {% for link in step.links.all %}
                    <div class="relative group">
                      <a href="{{ link.url }}" target="_blank" class="btn btn-outline btn-sm" data-link-id="{{ link.id }}">{{ link.title }}</a>
                      <button class="btn btn-xxs btn-error absolute -top-1 -right-1 opacity-0 group-hover:opacity-100 delete-link" data-step="{{ step.id }}" data-id="{{ link.id }}">‚úï</button>
                    </div>
                  {% endfor %}
                </div>
              </div>
              <!-- PDFs / CAD Files -->
              <div class="mt-3">
                <div class="text-sm opacity-70 mb-1">Documents (paste or drop PDF / DWG / IDW)</div>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-2" id="pdfs-{{ step.id }}">
                  {% for f in step.files.all %}
                    <div class="relative group">
                      <div class="rounded border w-full h-28 bg-base-300/30 flex items-center justify-center cursor-pointer pdf-thumb" data-url="{{ f.file.url }}" data-name="{{ f.file.name|basename }} ({{ f.uploaded_at|date:'mdy-HisA' }})" title="{{ f.file.name|basename }}">
                        <span class="text-xs">PDF</span>
                      </div>
                      <button class="btn btn-xs btn-error absolute top-1 right-1 opacity-0 group-hover:opacity-100 delete-pdf" data-step="{{ step.id }}" data-id="{{ f.id }}">‚úï</button>
                    </div>
                  {% endfor %}
                </div>
                <div class="mt-2 flex gap-2">
                  <input type="file" accept="application/pdf,.pdf,.dwg,.idw" class="hidden" data-upload-pdf-step="{{ step.id }}" />
                  <button type="button" class="btn btn-sm" data-open-pdf-upload="{{ step.id }}">Add Document</button>
                </div>
              </div>
              <div class="mt-3 img-section">
                <div class="text-sm opacity-70 mb-1">Screenshots (paste or drop images)</div>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-2" id="imgs-{{ step.id }}">
                  {% for img in step.images.all %}
                    <div class="relative group">
                      <img src="{{ img.image.url }}" class="rounded border object-cover w-full h-28" />
                      <button class="btn btn-xs btn-error absolute top-1 right-1 opacity-0 group-hover:opacity-100 delete-img" data-step="{{ step.id }}" data-id="{{ img.id }}">‚úï</button>
                    </div>
                  {% endfor %}
                </div>
                <div class="mt-2 flex gap-2">
                  <button type="button" class="btn btn-sm" data-open-upload="{{ step.id }}">Add images</button>
                  <input type="file" accept="image/*" multiple class="hidden" data-upload-step="{{ step.id }}" />
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>

    <div class="col-span-12">
      <h2 class="font-semibold mb-2">Notes</h2>
      <textarea id="process-notes" class="textarea textarea-bordered w-full min-h-40" placeholder="Any notes">{{ process.notes }}</textarea>
    </div>

    <div class="col-span-12">
      <div class="card bg-base-200 shadow-sm">
        <div class="card-body p-4">
          <div class="flex items-center justify-between mb-4">
            <h2 class="font-semibold text-lg">üìä Process Analysis</h2>
            <button id="analyze-btn" class="btn btn-accent btn-sm" data-process-id="{{ process.id }}">
              <i class="fas fa-brain mr-1"></i>Analyze Process
            </button>
          </div>
          
          <div class="mb-4">
            <label class="label">
              <span class="label-text font-medium">Analysis Instructions</span>
            </label>
            <textarea id="analysis-instructions" class="textarea textarea-bordered w-full min-h-32" placeholder="Instructions for AI analysis">{{ process.analysis_instructions }}</textarea>
          </div>
          
          <div>
            <label class="label">
              <span class="label-text font-medium">Analysis Results</span>
            </label>
            <textarea id="process-analysis" class="textarea textarea-bordered w-full min-h-40" placeholder="AI-generated analysis and improvement suggestions">{{ process.analysis }}</textarea>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Stats Modal -->
<dialog id="stats-modal" class="modal">
  <div class="modal-box w-11/12 max-w-2xl">
    <div class="flex items-center justify-between mb-6">
      <h3 class="font-bold text-2xl text-primary">üìä Process Statistics</h3>
      <button class="btn btn-sm btn-circle btn-ghost" onclick="document.getElementById('stats-modal').close()">‚úï</button>
    </div>
    <div id="stats-content" class="space-y-4">
      <!-- Stats will be loaded here -->
    </div>
  </div>
</dialog>

<!-- Image Viewer Modal (Full Screen) -->
<dialog id="image-modal" class="modal">
  <div class="modal-box w-screen h-screen max-w-none max-h-none p-0 bg-base-100 relative">
    <button class="btn btn-sm btn-circle btn-ghost absolute right-3 top-3 z-20" onclick="document.getElementById('image-modal').close()">‚úï</button>
    <div id="zoom-stage" class="w-full h-full overflow-hidden bg-base-100">
      <img id="modal-image" src="" alt="Full size image" class="select-none cursor-move will-change-transform" style="width:100%; height:100%; object-fit: contain; transform: translate(0px,0px) scale(1);" />
    </div>
  </div>
</dialog>

{% endblock %}

{% block extra_js %}
<!-- PDF.js for client-side PDF thumbnail rendering -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.3.136/pdf.min.js" integrity="sha512-0OqkJwYtX3WxbA1q3qkX6SC+h4Yl3fCk9t6Gxg8v8QKQ4M4w+0sXgK5g5QX7wAvm6sDg7fDc5e5M8i7w9Yj0PA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
if (window['pdfjsLib']) {
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.3.136/pdf.worker.min.js';
}
</script>
<script>
const processId = {{ process.id }};
const base = '/process-creator/' + processId + '/';

async function post(url, data){
  const form = new URLSearchParams();
  for(const [k,v] of Object.entries(data||{})) form.append(k,v);
  const res = await fetch(url, {method:'POST', headers:{'X-CSRFToken': getCookie('csrftoken')}, body:form});
  return res.json();
}

function getCookie(name){
  const value = `; ${document.cookie}`.split(`; ${name}=`).pop();
  return value ? value.split(';').shift() : '';
}

// Track if process has been updated since last AI interaction
let processUpdated = false;

// Autosave process fields
function debouncedSave(){
  clearTimeout(window._saveT); window._saveT = setTimeout(() => {
    post(base + 'update/', {
      description: document.getElementById('process-description').value,
      notes: document.getElementById('process-notes').value,
      summary: document.getElementById('process-summary').value,
      summary_instructions: document.getElementById('summary-instructions').value,
      analysis: document.getElementById('process-analysis').value,
      analysis_instructions: document.getElementById('analysis-instructions').value,
    }).then(() => {
      processUpdated = true;
    });
  }, 400);
}

document.getElementById('process-description').addEventListener('input', debouncedSave);
document.getElementById('process-notes').addEventListener('input', debouncedSave);
document.getElementById('process-summary').addEventListener('input', debouncedSave);
document.getElementById('summary-instructions').addEventListener('input', debouncedSave);
document.getElementById('process-analysis').addEventListener('input', debouncedSave);
document.getElementById('analysis-instructions').addEventListener('input', debouncedSave);

// Name change via simple submit to update endpoint
document.getElementById('process-name').addEventListener('change', async (e)=>{
  await fetch(base + 'update/', {method:'POST', headers:{'X-CSRFToken': getCookie('csrftoken')}, body:new URLSearchParams({name:e.target.value})});
});

// Module change via simple submit to update endpoint
document.getElementById('process-module').addEventListener('change', async (e)=>{
  if (e.target.value === '__new__') {
    openCreateModuleModal({ afterCreate: async (mod)=>{
      // set selected
      const sel = document.getElementById('process-module');
      const opt = document.createElement('option'); opt.value = mod.id; opt.textContent = mod.name;
      sel.insertBefore(opt, sel.querySelector('option[value="__new__"]'));
      sel.value = mod.id;
      await fetch(base + 'update/', {method:'POST', headers:{'X-CSRFToken': getCookie('csrftoken')}, body:new URLSearchParams({module:mod.id})});
    }});
    // restore current while modal open
    e.target.value = '{{ process.module.id|default:"" }}';
    return;
  }
  await fetch(base + 'update/', {method:'POST', headers:{'X-CSRFToken': getCookie('csrftoken')}, body:new URLSearchParams({module:e.target.value})});
});

// Add step
document.getElementById('add-step').addEventListener('click', async ()=>{
  const data = await post(base + 'steps/add/', {title:'New Step'});
  location.reload();
});

// Update step fields
document.querySelectorAll('#steps .card').forEach(card=>{
  const id = card.dataset.id;
  card.querySelector('.step-title').addEventListener('change', e=>{
    post(base + 'steps/' + id + '/update/', {title:e.target.value});
  });
  card.querySelector('.step-details').addEventListener('input', ()=>{
    clearTimeout(card._t); card._t = setTimeout(()=>{
      post(base + 'steps/' + id + '/update/', {details:card.querySelector('.step-details').value});
    }, 400);
  });
  card.querySelector('.step-delete').addEventListener('click', ()=>{
    post(base + 'steps/' + id + '/delete/').then(()=>location.reload());
  });
});

// Drag and drop ordering
let dragEl = null;
document.querySelectorAll('#steps .card .drag').forEach(handle=>{
  const card = handle.closest('.card');
  card.draggable = true;
  card.addEventListener('dragstart', ()=>{ dragEl = card; card.classList.add('opacity-50'); });
  card.addEventListener('dragend', ()=>{ card.classList.remove('opacity-50'); dragEl = null; saveOrder(); });
});

document.getElementById('steps').addEventListener('dragover', (e)=>{
  e.preventDefault();
  const container = e.currentTarget;
  const afterEl = Array.from(container.querySelectorAll('.card')).find(el=>{
    const rect = el.getBoundingClientRect();
    return e.clientY < rect.top + rect.height/2;
  });
  if (!afterEl) container.appendChild(dragEl); else container.insertBefore(dragEl, afterEl);
});

function saveOrder(){
  const ids = Array.from(document.querySelectorAll('#steps .card')).map(c=>c.dataset.id);
  const form = new URLSearchParams(); ids.forEach(id=>form.append('order[]', id));
  fetch(base + 'steps/reorder/', {method:'POST', headers:{'X-CSRFToken': getCookie('csrftoken')}, body:form});
}

// Copy markdown to clipboard
document.getElementById('copy-btn').addEventListener('click', async (e)=>{
  e.preventDefault();
  const url = e.currentTarget.dataset.copyUrl;
  try {
    const res = await fetch(url);
    const text = await res.text();
    await navigator.clipboard.writeText(text);
    const toast = document.createElement('div');
    toast.className = 'toast toast-top toast-end';
    toast.innerHTML = '<div class="alert alert-success"><span>Copied Markdown to clipboard.</span></div>';
    document.body.appendChild(toast);
    setTimeout(()=>toast.remove(), 1500);
  } catch(err) {
    const toast = document.createElement('div');
    toast.className = 'toast toast-top toast-end';
    toast.innerHTML = '<div class="alert alert-error"><span>Copy failed.</span></div>';
    document.body.appendChild(toast);
    setTimeout(()=>toast.remove(), 2000);
  }
});


// Image uploads via file input
document.querySelectorAll('input[data-upload-step]').forEach(input=>{
  input.addEventListener('change', async (e)=>{
    const stepId = e.currentTarget.getAttribute('data-upload-step');
    for (const file of e.currentTarget.files) {
      const fd = new FormData(); fd.append('image', file);
      const res = await fetch(base + 'steps/' + stepId + '/images/upload/', {method:'POST', headers:{'X-CSRFToken': getCookie('csrftoken')}, body: fd});
      const data = await res.json(); if (data.ok) addThumb(stepId, data);
    }
    e.currentTarget.value = '';
  });
});

// Dedicated button opens file input
document.querySelectorAll('[data-open-upload]').forEach(btn=>{
  btn.addEventListener('click', (e)=>{
    e.preventDefault();
    const stepId = e.currentTarget.getAttribute('data-open-upload');
    const input = document.querySelector(`input[data-upload-step="${stepId}"]`);
    if (input) input.click();
  });
});

// Master toggle show/hide all attachments (display only; print unaffected)
const imgToggle = document.getElementById('toggle-images');
const TOGGLE_KEY = 'process_creator_show_attachments';
function applyAttachmentVisibility(){
  const show = imgToggle.checked;
  // Hide/show images
  document.querySelectorAll('.img-section').forEach(sec=>{
    sec.style.display = show ? '' : 'none';
  });
  // Hide/show documents (PDFs/CAD files)
  document.querySelectorAll('.mt-3').forEach(sec=>{
    if (sec.querySelector('.text-sm.opacity-70')?.textContent?.includes('Documents')) {
      sec.style.display = show ? '' : 'none';
    }
  });
  // Hide/show links
  document.querySelectorAll('.mt-3').forEach(sec=>{
    if (sec.querySelector('.text-sm.opacity-70')?.textContent?.includes('Links')) {
      sec.style.display = show ? '' : 'none';
    }
  });
  try { localStorage.setItem(TOGGLE_KEY, show ? '1' : '0'); } catch(e) {}
}
// Initialize from localStorage (default: show)
try {
  const saved = localStorage.getItem(TOGGLE_KEY);
  if (saved === '0') imgToggle.checked = false;
} catch(e) {}
imgToggle.addEventListener('change', applyAttachmentVisibility);
// Apply once on load
applyAttachmentVisibility();

// Stats modal functionality
document.getElementById('stats-btn').addEventListener('click', async (e)=>{
  e.preventDefault();
  const modal = document.getElementById('stats-modal');
  const content = document.getElementById('stats-content');
  
  try {
    const res = await fetch(`/process-creator/${processId}/stats/`);
    const data = await res.json();
    
    content.innerHTML = `
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Timeline Section -->
        <div class="card bg-base-200 shadow-sm">
          <div class="card-body p-4">
            <h4 class="card-title text-lg text-primary mb-4">üìÖ Timeline</h4>
            <div class="space-y-3">
              <div class="flex items-center gap-3">
                <div class="badge badge-primary badge-sm">Created</div>
                <div class="text-sm font-medium">${data.created_at}</div>
              </div>
              <div class="flex items-center gap-3">
                <div class="badge badge-secondary badge-sm">Updated</div>
                <div class="text-sm font-medium">${data.updated_at}</div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Content Stats -->
        <div class="card bg-base-200 shadow-sm">
          <div class="card-body p-4">
            <h4 class="card-title text-lg text-accent mb-4">üìù Content</h4>
            <div class="space-y-3">
              <div class="flex justify-between items-center">
                <span class="text-sm opacity-70">Steps</span>
                <div class="badge badge-accent badge-lg">${data.step_count}</div>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-sm opacity-70">Substeps</span>
                <div class="badge badge-secondary badge-lg">${data.substep_count || 0}</div>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-sm opacity-70">Total Steps</span>
                <div class="badge badge-primary badge-lg">${data.total_steps || data.step_count}</div>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-sm opacity-70">Images</span>
                <div class="badge badge-accent badge-lg">${data.image_count}</div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Text Stats -->
        <div class="card bg-base-200 shadow-sm">
          <div class="card-body p-4">
            <h4 class="card-title text-lg text-info mb-4">üìÑ Text Content</h4>
            <div class="space-y-3">
              <div class="flex justify-between items-center">
                <span class="text-sm opacity-70">Description</span>
                <div class="text-sm font-medium">${data.description_length} chars</div>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-sm opacity-70">Notes</span>
                <div class="text-sm font-medium">${data.notes_length} chars</div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Summary Stats -->
        <div class="card bg-gradient-to-br from-primary to-secondary text-primary-content shadow-lg">
          <div class="card-body p-4">
            <h4 class="card-title text-lg mb-4">üéØ Summary</h4>
            <div class="space-y-2">
              <div class="flex justify-between">
                <span class="text-sm opacity-90">Total Content</span>
                <span class="font-bold">${(data.total_steps || data.step_count) + data.image_count} items</span>
              </div>
              <div class="flex justify-between">
                <span class="text-sm opacity-90">Text Length</span>
                <span class="font-bold">${data.description_length + data.notes_length} chars</span>
              </div>
              <div class="divider my-2"></div>
              <div class="text-center">
                <div class="text-2xl font-bold">${(data.total_steps || data.step_count) > 0 ? Math.round(data.image_count / (data.total_steps || data.step_count) * 10) / 10 : 0}</div>
                <div class="text-sm opacity-90">images per step</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
    
    modal.showModal();
  } catch(err) {
    content.innerHTML = `
      <div class="alert alert-error">
        <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <span>Failed to load statistics. Please try again.</span>
      </div>
    `;
    modal.showModal();
  }
});

// AI Create Summary
document.getElementById('create-summary-btn').addEventListener('click', async (e)=>{
  e.preventDefault();
  const btn = e.target;
  const originalText = btn.innerHTML;
  
  try {
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Creating...';
    
    const instructions = document.getElementById('summary-instructions').value;
    const res = await fetch(`/process-creator/${processId}/ai/summary/`, {
      method: 'POST',
      headers: {'X-CSRFToken': getCookie('csrftoken'), 'Content-Type': 'application/json'},
      body: JSON.stringify({instructions: instructions})
    });
    
    if (!res.ok) {
      throw new Error(`HTTP error! status: ${res.status}`);
    }
    
    const data = await res.json();
    if (data.success) {
      document.getElementById('process-summary').value = data.summary;
      
      // Show success toast
      const toast = document.createElement('div');
      toast.className = 'toast toast-top toast-end';
      toast.innerHTML = '<div class="alert alert-success"><span>Process summary created successfully!</span></div>';
      document.body.appendChild(toast);
      setTimeout(()=>toast.remove(), 3000);
    } else {
      throw new Error(data.error || 'Failed to generate process summary');
    }
  } catch(err) {
    const toast = document.createElement('div');
    toast.className = 'toast toast-top toast-end';
    toast.innerHTML = '<div class="alert alert-error"><span>Failed to create process summary: ' + err.message + '</span></div>';
    document.body.appendChild(toast);
    setTimeout(()=>toast.remove(), 5000);
  } finally {
    btn.disabled = false;
    btn.innerHTML = originalText;
  }
});

// AI Analysis
document.getElementById('analyze-btn').addEventListener('click', async (e)=>{
  e.preventDefault();
  const btn = e.target;
  const originalText = btn.innerHTML;
  
  try {
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Analyzing...';
    
    const instructions = document.getElementById('analysis-instructions').value;
    const res = await fetch(`/process-creator/${processId}/ai/analyze/`, {
      method: 'POST',
      headers: {'X-CSRFToken': getCookie('csrftoken'), 'Content-Type': 'application/json'},
      body: JSON.stringify({instructions: instructions})
    });
    
    if (!res.ok) {
      throw new Error(`HTTP error! status: ${res.status}`);
    }
    
    const data = await res.json();
    if (data.success) {
      document.getElementById('process-analysis').value = data.analysis;
      
      // Show success toast
      const toast = document.createElement('div');
      toast.className = 'toast toast-top toast-end';
      toast.innerHTML = '<div class="alert alert-success"><span>Process analysis completed successfully!</span></div>';
      document.body.appendChild(toast);
      setTimeout(()=>toast.remove(), 3000);
    } else {
      throw new Error(data.error || 'Failed to generate analysis');
    }
  } catch(err) {
    const toast = document.createElement('div');
    toast.className = 'toast toast-top toast-end';
    toast.innerHTML = '<div class="alert alert-error"><span>Failed to generate process analysis: ' + err.message + '</span></div>';
    document.body.appendChild(toast);
    setTimeout(()=>toast.remove(), 5000);
  } finally {
    btn.disabled = false;
    btn.innerHTML = originalText;
  }
});

// Image click handler - open images in modal
document.addEventListener('click', (e) => {
  // Check if clicked element is an image within a step
  if (e.target.tagName === 'IMG' && e.target.closest('[id^="imgs-"]')) {
    e.preventDefault();
    const imgSrc = e.target.src;
    const modal = document.getElementById('image-modal');
    // reset zoom/position
    currentScale = 1; offsetX = 0; offsetY = 0; applyTransform();
    // ensure image element is restored in stage
    const stage = document.getElementById('zoom-stage');
    stage.innerHTML = '';
    const imgEl = document.createElement('img');
    imgEl.id = 'modal-image';
    imgEl.alt = 'Full size image';
    imgEl.className = 'select-none cursor-move will-change-transform';
    imgEl.style.width = '100%'; imgEl.style.height = '100%'; imgEl.style.objectFit = 'contain';
    imgEl.style.transform = 'translate(0px,0px) scale(1)';
    imgEl.src = imgSrc;
    stage.appendChild(imgEl);
    modalImgEl = imgEl;
    modal.showModal();
  }
});

// Image grid click handler removed - only "Add images" button opens file dialog

// Paste handler on window - attach to nearest focused step card
document.addEventListener('paste', async (e)=>{
  const items = e.clipboardData && e.clipboardData.items; if (!items) return;
  let file = null; let urlText = null; let pdfFile = null; let cadFile = null;
  const textPromise = new Promise(resolve=>{
    let resolved = false;
    for (const it of items) {
      if (it.kind === 'string' && it.type === 'text/plain') {
        it.getAsString(t=>{ if (!resolved){ urlText = t; resolved = true; resolve(); } });
      }
    }
    // Fallback resolve quickly if no text item
    setTimeout(()=>{ if (!resolved) resolve(); }, 0);
  });
  for (const it of items) {
    if (it.type && it.type.indexOf('image') !== -1) { file = it.getAsFile(); }
    if (it.type === 'application/pdf') { pdfFile = it.getAsFile(); }
    if (it.kind === 'file' && it.type === '') { // Some CAD types lack a MIME
      const f = it.getAsFile();
      if (f && (/\.dwg$/i.test(f.name) || /\.idw$/i.test(f.name))) cadFile = f;
    }
  }
  await textPromise;
  // find focused step
  const active = document.activeElement.closest('.card');
  if (!active) return;
  const stepId = active.dataset.id;
  // If CAD pasted (DWG / IDW)
  if (cadFile) {
    const fd = new FormData(); fd.append('file', cadFile);
    try {
      const res = await fetch(base + 'steps/' + stepId + '/files/upload/', {method:'POST', headers:{'X-CSRFToken': getCookie('csrftoken')}, body: fd});
      const data = await res.json();
      if (data.ok) {
        // Add a link button with the filename
        addLinkButton(stepId, {title: (cadFile.name || 'Document'), url: data.url});
        // Also show it in the documents grid for download
        addPdfThumb(stepId, data);
      } else {
        showToast(data.error || 'Conversion failed', 'error');
      }
    } catch(err){ showToast('Conversion failed', 'error'); }
    return;
  }
  // If PDF pasted
  if (pdfFile) {
    const fd = new FormData(); fd.append('file', pdfFile);
    try {
      const res = await fetch(base + 'steps/' + stepId + '/files/upload/', {method:'POST', headers:{'X-CSRFToken': getCookie('csrftoken')}, body: fd});
      const data = await res.json(); if (data.ok) addPdfThumb(stepId, data); else showToast(data.error || 'Upload failed', 'error');
    } catch(err){ showToast('Upload failed', 'error'); }
    return;
  }
  // If image pasted
  if (file) {
    const fd = new FormData(); fd.append('file', file);
    const res = await fetch(base + 'steps/' + stepId + '/images/upload/', {method:'POST', headers:{'X-CSRFToken': getCookie('csrftoken')}, body: fd});
    const data = await res.json(); if (data.ok) addThumb(stepId, data);
    return;
  }
  // If plain text URL pasted into details
  if (urlText && /^https?:\/\//i.test(urlText.trim())) {
    // prevent the URL from being inserted in the textarea
    e.preventDefault();
    const targetTA = e.target.classList.contains('step-details') ? e.target : null;
    const pastedUrl = urlText.trim();
    openCreateLinkModal(pastedUrl, async ({title, url})=>{
      const res = await fetch(base + 'steps/' + stepId + '/links/add/', {method:'POST', headers:{'X-CSRFToken': getCookie('csrftoken'), 'Content-Type':'application/json'}, body: JSON.stringify({title, url})});
      const data = await res.json();
      if (data.ok) {
        addLinkButton(stepId, data);
        if (targetTA) {
          // remove any residual pasted text
          const {selectionStart: s, selectionEnd: epos} = targetTA;
          if (s != null && epos != null && s !== epos) {
            const cur = targetTA.value; targetTA.value = cur.slice(0, s) + cur.slice(epos);
          } else if (targetTA.value.includes(pastedUrl)) {
            targetTA.value = targetTA.value.replace(pastedUrl, '');
          }
        }
      }
    });
  }
});

// Delete image - use event delegation for all images
document.addEventListener('click', async (e)=>{
  const deleteBtn = e.target.closest('.delete-img');
  if (!deleteBtn) return;
  
  e.preventDefault();
  e.stopPropagation();
  
  const stepId = deleteBtn.getAttribute('data-step');
  const id = deleteBtn.getAttribute('data-id');
  
  try {
    await fetch(base + 'steps/' + stepId + '/images/' + id + '/delete/', {
      method:'POST', 
      headers:{'X-CSRFToken': getCookie('csrftoken')}
    });
    deleteBtn.closest('.relative').remove();
  } catch(err) {
    console.error('Failed to delete image:', err);
  }
});

// Delete link - use event delegation for all links
document.addEventListener('click', async (e)=>{
  const deleteBtn = e.target.closest('.delete-link');
  if (!deleteBtn) return;
  
  e.preventDefault();
  e.stopPropagation();
  
  const stepId = deleteBtn.getAttribute('data-step');
  const id = deleteBtn.getAttribute('data-id');
  
  try {
    await fetch(base + 'steps/' + stepId + '/links/' + id + '/delete/', {
      method:'POST', 
      headers:{'X-CSRFToken': getCookie('csrftoken')}
    });
    deleteBtn.closest('.relative').remove();
  } catch(err) {
    console.error('Failed to delete link:', err);
  }
});

function addThumb(stepId, data){
  const container = document.getElementById('imgs-'+stepId);
  const div = document.createElement('div');
  div.className = 'relative group';
  div.innerHTML = `<img src="${data.url}" class="rounded border object-cover w-full h-28" /><button class="btn btn-xs btn-error absolute top-1 right-1 opacity-0 group-hover:opacity-100 delete-img" data-step="${stepId}" data-id="${data.id}">‚úï</button>`;
  container.appendChild(div);
  // Event listener is now handled by event delegation above
}

function addLinkButton(stepId, data){
  const container = document.getElementById('links-'+stepId);
  const div = document.createElement('div');
  div.className = 'relative group';
  div.innerHTML = `<a href="${data.url}" target="_blank" class="btn btn-outline btn-sm" data-link-id="${data.id}">${data.title}</a><button class="btn btn-xxs btn-error absolute -top-1 -right-1 opacity-0 group-hover:opacity-100 delete-link" data-step="${stepId}" data-id="${data.id}">‚úï</button>`;
  container.appendChild(div);
}

function addPdfThumb(stepId, data){
  const container = document.getElementById('pdfs-'+stepId);
  const div = document.createElement('div');
  div.className = 'relative group';
  const ts = new Date();
  const pad = n => String(n).padStart(2,'0');
  const hours12 = (h)=>{ const hh = h % 12 || 12; return pad(hh); };
  const ampm = ts.getHours() >= 12 ? 'PM' : 'AM';
  const stamp = `${pad(ts.getMonth()+1)}${pad(ts.getDate())}${String(ts.getFullYear()).slice(-2)}-${hours12(ts.getHours())}${pad(ts.getMinutes())}${pad(ts.getSeconds())}${ampm}`;
  const baseName = (data.name || 'PDF');
  const parts = baseName.split('.');
  const ext = parts.length > 1 ? '.' + parts.pop() : '';
  const nameWithStamp = `${parts.join('.')} (${stamp})${ext}`;
  div.innerHTML = `<div class=\"rounded border w-full h-28 bg-base-300/30 flex items-center justify-center cursor-pointer pdf-thumb\" data-url=\"${data.url}\" data-name=\"${nameWithStamp}\" title=\"${nameWithStamp}\"><span class=\"text-xs\">Loading‚Ä¶</span></div><button class=\"btn btn-xs btn-error absolute top-1 right-1 opacity-0 group-hover:opacity-100 delete-pdf\" data-step=\"${stepId}\" data-id=\"${data.id}\">‚úï</button>`;
  container.appendChild(div);
  const thumb = div.querySelector('.pdf-thumb');
  renderPdfThumbnail(thumb);
}

// PDF upload button
document.querySelectorAll('[data-open-pdf-upload]').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const stepId = btn.getAttribute('data-open-pdf-upload');
    const input = document.querySelector(`[data-upload-pdf-step="${stepId}"]`);
    input.click();
  });
});

document.querySelectorAll('[data-upload-pdf-step]').forEach(input=>{
  input.addEventListener('change', async ()=>{
    const stepId = input.getAttribute('data-upload-pdf-step');
    const file = input.files[0]; if (!file) return;
    const fd = new FormData(); fd.append('file', file);
    const res = await fetch(base + 'steps/' + stepId + '/files/upload/', {method:'POST', headers:{'X-CSRFToken': getCookie('csrftoken')}, body: fd});
    const data = await res.json(); if (data.ok) addPdfThumb(stepId, data);
    input.value = '';
  });
});

// PDF preview and delete
document.addEventListener('click', async (e)=>{
  const pdfDiv = e.target.closest('.pdf-thumb');
  if (pdfDiv) {
    const rawUrl = pdfDiv.getAttribute('data-url');
    // Build absolute same-origin URL
    let absUrl = rawUrl;
    try {
      absUrl = new URL(rawUrl, window.location.origin).href;
    } catch(_) {}
    // reuse image modal to show PDF via iframe
    const modal = document.getElementById('image-modal');
    const stage = document.getElementById('zoom-stage');
    stage.innerHTML = `
      <object data="${absUrl}#view=FitH" type="application/pdf" class="w-full h-full">
        <iframe src="${absUrl}#view=FitH" class="w-full h-full" style="border:0" allow="fullscreen"></iframe>
        <div class="w-full h-full flex items-center justify-center gap-3">
          <span class="text-sm opacity-70">Cannot preview PDF here.</span>
          <a href="${absUrl}" target="_blank" class="btn btn-sm">Open PDF</a>
        </div>
      </object>`;
    modal.showModal();
    return;
  }
  const delBtn = e.target.closest('.delete-pdf');
  if (delBtn) {
    e.preventDefault(); e.stopPropagation();
    const stepId = delBtn.getAttribute('data-step');
    const id = delBtn.getAttribute('data-id');
    await fetch(base + 'steps/' + stepId + '/files/' + id + '/delete/', {method:'POST', headers:{'X-CSRFToken': getCookie('csrftoken')}});
    delBtn.closest('.relative').remove();
  }
});

// Render a PDF thumbnail (first page) into the given .pdf-thumb element
async function renderPdfThumbnail(thumbEl){
  const fallbackToName = ()=>{
    const name = thumbEl.getAttribute('data-name') || thumbEl.getAttribute('title') || (thumbEl.getAttribute('data-url')||'').split('/').pop() || 'PDF';
    thumbEl.innerHTML = `<span class=\"text-xs truncate px-2\">${name}</span>`;
  };
  if (!thumbEl) return;
  if (!window['pdfjsLib']) { fallbackToName(); return; }
  let aborted = false;
  const timer = setTimeout(()=>{ if (!aborted) fallbackToName(); }, 4000);
  try {
    await new Promise(r=>requestAnimationFrame(()=>requestAnimationFrame(r)));
    let rawUrl = thumbEl.getAttribute('data-url');
    let absUrl = new URL(rawUrl, window.location.origin).href;
    const resp = await fetch(absUrl, { credentials: 'same-origin' });
    if (!resp.ok) throw new Error('Failed to fetch PDF');
    const buffer = await resp.arrayBuffer();
    const loadingTask = pdfjsLib.getDocument({ data: buffer });
    const pdf = await loadingTask.promise;
    const page = await pdf.getPage(1);
    const containerWidth = thumbEl.clientWidth || thumbEl.offsetWidth || 320;
    const containerHeight = thumbEl.clientHeight || thumbEl.offsetHeight || 112;
    const viewport = page.getViewport({ scale: 1 });
    const scale = Math.min(containerWidth / viewport.width, containerHeight / viewport.height) || 0.5;
    const scaledViewport = page.getViewport({ scale: Math.max(0.2, Math.min(2, scale)) });
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = Math.max(1, Math.floor(scaledViewport.width));
    canvas.height = Math.max(1, Math.floor(scaledViewport.height));
    await page.render({ canvasContext: ctx, viewport: scaledViewport }).promise;
    thumbEl.innerHTML = '';
    canvas.className = 'w-full h-full object-contain';
    thumbEl.appendChild(canvas);
    aborted = true; clearTimeout(timer);
  } catch(err){
    aborted = true; clearTimeout(timer); fallbackToName();
  }
}

// Render thumbnails for any existing PDF entries on load
document.addEventListener('DOMContentLoaded', ()=>{
  setTimeout(()=>{
    document.querySelectorAll('.pdf-thumb').forEach(el=>{
      // If server-rendered without data-name, synthesize timestamped name for display fallback
      if (!el.getAttribute('data-name')) {
        const orig = el.getAttribute('title') || (el.getAttribute('data-url')||'').split('/').pop() || 'Document.pdf';
        const ts = new Date();
        const pad = n=>String(n).padStart(2,'0');
        const hours12 = h=>{ const hh = h % 12 || 12; return pad(hh); };
        const ampm = ts.getHours() >= 12 ? 'PM' : 'AM';
        const stamp = `${pad(ts.getMonth()+1)}${pad(ts.getDate())}${String(ts.getFullYear()).slice(-2)}-${hours12(ts.getHours())}${pad(ts.getMinutes())}${pad(ts.getSeconds())}${ampm}`;
        const parts = orig.split('.'); const ext = parts.length>1?'.'+parts.pop():'';
        const withStamp = `${parts.join('.')} (${stamp})${ext}`;
        el.setAttribute('data-name', withStamp);
      }
      renderPdfThumbnail(el);
    });
  }, 50);
});

// Link creation modal
function openCreateLinkModal(initialUrl, onSave){
  let modal = document.getElementById('create-link-modal');
  if (!modal) {
    modal = document.createElement('dialog');
    modal.id = 'create-link-modal';
    modal.className = 'modal';
    modal.innerHTML = `
      <div class="modal-box">
        <h3 class="font-bold text-lg mb-3">Create Link</h3>
        <div class="form-control mb-2">
          <label class="label"><span class="label-text">Button Label</span></label>
          <input id="new-link-title" class="input input-bordered" placeholder="Link label" />
        </div>
        <div class="form-control mb-4">
          <label class="label"><span class="label-text">URL</span></label>
          <input id="new-link-url" class="input input-bordered" placeholder="https://..." />
        </div>
        <div class="modal-action">
          <button id="create-link-cancel" class="btn btn-ghost">Cancel</button>
          <button id="create-link-save" class="btn btn-primary">Create</button>
        </div>
      </div>`;
    document.body.appendChild(modal);
  }
  modal.showModal();
  modal.querySelector('#new-link-title').value = '';
  modal.querySelector('#new-link-url').value = initialUrl || '';
  modal.querySelector('#create-link-cancel').onclick = ()=> modal.close();
  modal.querySelector('#create-link-save').onclick = ()=>{
    const title = modal.querySelector('#new-link-title').value.trim();
    const url = modal.querySelector('#new-link-url').value.trim();
    if (!title || !/^https?:\/\//i.test(url)) { showToast('Provide label and valid URL', 'error'); return; }
    modal.close(); onSave && onSave({title, url});
  };
}

// Zoom & Pan for image modal
let currentScale = 1;
let offsetX = 0, offsetY = 0;
let isPanning = false, startX = 0, startY = 0;

let modalImgEl = document.getElementById('modal-image');
const zoomStage = document.getElementById('zoom-stage');

function applyTransform(){
  modalImgEl.style.transform = `translate(${offsetX}px, ${offsetY}px) scale(${currentScale})`;
  modalImgEl.style.transformOrigin = 'center center';
}

zoomStage.addEventListener('wheel', (e)=>{
  e.preventDefault();
  const delta = e.deltaY;
  const factor = delta > 0 ? 0.9 : 1.1;
  const prevScale = currentScale;
  currentScale = Math.min(10, Math.max(1, currentScale * factor));

  // Zoom towards cursor: adjust offset based on cursor position
  const rect = zoomStage.getBoundingClientRect();
  const cx = e.clientX - rect.left - rect.width/2;
  const cy = e.clientY - rect.top - rect.height/2;
  offsetX = (offsetX - cx) * (currentScale/prevScale) + cx;
  offsetY = (offsetY - cy) * (currentScale/prevScale) + cy;
  applyTransform();
}, { passive: false });

modalImgEl.addEventListener('mousedown', (e)=>{
  isPanning = true; startX = e.clientX - offsetX; startY = e.clientY - offsetY;
});
window.addEventListener('mousemove', (e)=>{
  if (!isPanning) return;
  offsetX = e.clientX - startX; offsetY = e.clientY - startY; applyTransform();
});
window.addEventListener('mouseup', ()=>{ isPanning = false; });

// Double click to reset
zoomStage.addEventListener('dblclick', ()=>{ currentScale = 1; offsetX = 0; offsetY = 0; applyTransform(); });

// Insert step before/after with event delegation (more reliable)
document.getElementById('steps').addEventListener('click', async (e)=>{
  const btn = e.target.closest('button[data-insert]');
  if (!btn) return;
  e.preventDefault();
  const card = btn.closest('.card');
  if (!card) return;
  const id = card.dataset.id;
  const dir = btn.getAttribute('data-insert');
  try {
    btn.disabled = true;
    const res = await fetch(base + 'steps/' + id + '/insert/' + dir + '/', {method:'POST', headers:{'X-CSRFToken': getCookie('csrftoken')}});
    const data = await res.json();
    if (data && data.ok) {
      location.reload();
    } else {
      btn.disabled = false;
    }
  } catch(err) {
    btn.disabled = false;
  }
});
</script>
<script>
// Reuse same modal helper as list page if absent
function showToast(message, type = 'success') {
  const toast = document.createElement('div');
  toast.className = 'toast toast-top toast-end';
  toast.style.position = 'fixed';
  toast.style.bottom = '0.75rem';
  toast.style.right = '0.75rem';
  toast.style.zIndex = '2147483647';
  toast.innerHTML = `<div class="alert alert-${type} max-w-[32rem] whitespace-pre-wrap break-words shadow-xl"><span>${message}</span></div>`;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), type === 'error' ? 7000 : 3000);
}
function openCreateModuleModal({afterCreate}={}){
  let modal = document.getElementById('create-module-modal');
  if (!modal) {
    modal = document.createElement('dialog');
    modal.id = 'create-module-modal';
    modal.className = 'modal';
    modal.innerHTML = `
      <div class="modal-box">
        <h3 class="font-bold text-lg mb-3">Create Module</h3>
        <div class="form-control mb-2">
          <label class="label"><span class="label-text">Name</span></label>
          <input id="new-module-name" class="input input-bordered" placeholder="e.g., Engineering/Drafting" />
        </div>
        <div class="form-control mb-4">
          <label class="label"><span class="label-text">Description (optional)</span></label>
          <textarea id="new-module-desc" class="textarea textarea-bordered" rows="3" placeholder="Short description"></textarea>
        </div>
        <div class="modal-action">
          <button id="create-module-cancel" class="btn btn-ghost">Cancel</button>
          <button id="create-module-save" class="btn btn-primary">Create</button>
        </div>
      </div>`;
    document.body.appendChild(modal);
  }
  modal.showModal();
  modal.querySelector('#create-module-cancel').onclick = ()=> modal.close();
  modal.querySelector('#create-module-save').onclick = async ()=>{
    const name = modal.querySelector('#new-module-name').value.trim();
    const description = modal.querySelector('#new-module-desc').value.trim();
    if (!name) { showToast('Module name is required', 'error'); return; }
    try {
      const res = await fetch('{% url "process_creator:module_create" %}', {
        method: 'POST', headers: {'X-CSRFToken': getCookie('csrftoken'), 'Content-Type': 'application/json'},
        body: JSON.stringify({name, description})
      });
      const data = await res.json();
      if (!res.ok || !data.ok) throw new Error(data.error || 'Failed to create module');
      modal.close();
      showToast('Module created', 'success');
      afterCreate && afterCreate({id: data.id, name: data.name});
    } catch(err) {
      console.error(err);
      showToast(err.message, 'error');
    }
  };
}
</script>
{% endblock %}


