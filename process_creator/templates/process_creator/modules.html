{% extends 'base.html' %}
{% block title %}Manage Modules{% endblock %}
{% block content %}
<div class="max-w-5xl mx-auto px-2 sm:px-4">
  <div class="flex items-center justify-between mb-4">
    <h1 class="text-2xl font-bold">Modules</h1>
    <a href="{% url 'process_creator:list' %}" class="btn btn-ghost">Back</a>
  </div>

  <div class="card bg-base-200 shadow-sm mb-6">
    <div class="card-body">
      <h2 class="card-title">Create Module</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
        <input id="new-name" class="input input-bordered" placeholder="Name" />
        <input id="new-desc" class="input input-bordered md:col-span-2" placeholder="Description (optional)" />
      </div>
      <div class="mt-3">
        <button id="create-btn" class="btn btn-primary">Create</button>
      </div>
    </div>
  </div>

  <div class="card bg-base-200 shadow-sm">
    <div class="card-body">
      <h2 class="card-title">Existing Modules</h2>
      <div id="list" class="space-y-2">
        {% for m in modules %}
        <div class="flex flex-col md:flex-row items-stretch md:items-center gap-2 p-2 bg-base-100 rounded">
          <input class="input input-bordered flex-1 name" value="{{ m.name }}" />
          <input class="input input-bordered flex-1 desc" value="{{ m.description }}" placeholder="Description" />
          <div class="flex gap-2">
            <button class="btn btn-sm btn-primary" data-action="save" data-id="{{ m.id }}">Save</button>
            <button class="btn btn-sm btn-error" data-action="delete" data-id="{{ m.id }}">Delete</button>
          </div>
        </div>
        {% empty %}
        <div class="text-sm opacity-70">No modules yet.</div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function getCookie(name){
  const value = `; ${document.cookie}`.split(`; ${name}=`).pop();
  return value ? value.split(';').shift() : '';
}

document.getElementById('create-btn').addEventListener('click', async ()=>{
  const name = document.getElementById('new-name').value.trim();
  const description = document.getElementById('new-desc').value.trim();
  if (!name) { showToast('Name is required', 'error'); return; }
  try {
    const res = await fetch('{% url "process_creator:module_create" %}', {
      method: 'POST',
      headers: { 'X-CSRFToken': getCookie('csrftoken'), 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, description })
    });
    const data = await res.json();
    if (!res.ok || !data.ok) throw new Error(data.error || 'Failed to create');
    location.reload();
  } catch(err) { showToast(err.message, 'error'); }
});

document.getElementById('list').addEventListener('click', async (e)=>{
  const btn = e.target.closest('button[data-action]');
  if (!btn) return;
  const row = btn.closest('div');
  const id = btn.dataset.id;
  if (btn.dataset.action === 'save') {
    const name = row.querySelector('.name').value.trim();
    const description = row.querySelector('.desc').value.trim();
    if (!name) { showToast('Name is required', 'error'); return; }
    try {
      const res = await fetch('{% url "process_creator:module_update" 0 %}'.replace('0', id), {
        method: 'POST',
        headers: { 'X-CSRFToken': getCookie('csrftoken'), 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, description })
      });
      const data = await res.json();
      if (!res.ok || !data.ok) throw new Error(data.error || 'Failed to save');
      showToast('Saved', 'success');
    } catch(err) { showToast(err.message, 'error'); }
  }
  if (btn.dataset.action === 'delete') {
    if (!confirm('Delete this module?')) return;
    try {
      const res = await fetch('{% url "process_creator:module_delete" 0 %}'.replace('0', id), {
        method: 'POST',
        headers: { 'X-CSRFToken': getCookie('csrftoken') }
      });
      const data = await res.json();
      if (!res.ok || !data.ok) throw new Error(data.error || 'Failed to delete');
      row.remove();
      showToast('Deleted', 'success');
    } catch(err) { showToast(err.message, 'error'); }
  }
});

function showToast(message, type='success'){
  const t = document.createElement('div');
  t.className = 'toast toast-top toast-end';
  t.innerHTML = `<div class="alert alert-${type}"><span>${message}</span></div>`;
  document.body.appendChild(t);
  setTimeout(()=>t.remove(), type==='error'?4000:2000);
}
</script>
{% endblock %}


