{% extends "base.html" %}
{% load process_filters %}
{% block content %}
<div class="p-4 space-y-4">
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-2xl font-bold">{{ JOB_LABEL }}: {{ job.name }}</h1>
      <div class="opacity-70 text-sm">From Template: <a class="link" href="{% url 'process_creator:template_detail' job.template.id %}">{{ job.template.name }}</a></div>
    </div>
    <div class="space-x-2">
      {% if job.status == 'not_started' %}
        <a class="btn btn-sm btn-primary" href="{% url 'process_creator:job_start' job.id %}">Start</a>
      {% endif %}
      <a class="btn btn-sm" href="{% url 'process_creator:job_print' job.id %}">Print</a>
      <a class="btn btn-sm" href="{% url 'process_creator:job_pdf' job.id %}">PDF</a>
      <a class="btn btn-sm" href="{% url 'process_creator:job_word' job.id %}">Word</a>
    </div>
  </div>

  <div class="flex items-center gap-2">
    <div class="badge badge-primary">{{ progress.completed }}/{{ progress.total }} Completed</div>
    <div class="badge badge-info">{{ overall_percent }}% Overall</div>
    {% if progress.blocked %}<div class="badge badge-error">{{ progress.blocked }} Blocked</div>{% endif %}
    {% if template_newer %}
      <div class="badge badge-warning">Template updated (v{{ job.template.version }})</div>
      <form method="post" action="{% url 'process_creator:job_update_from_template' job.id %}">
        {% csrf_token %}
        <button class="btn btn-sm btn-warning">Update Process</button>
      </form>
    {% endif %}
    <div class="ml-auto flex gap-2">
      <a class="btn btn-sm" href="{% url 'process_creator:job_list' %}">All {{ JOB_LABEL }}s</a>
      <a class="btn btn-sm" href="{% url 'process_creator:template_detail' job.template.id %}">Template</a>
      <a class="btn btn-sm" href="{% url 'process_creator:list' %}">Processes</a>
    </div>
  </div>

  <div class="space-y-4">
    {% for s in job.steps.all %}
      <div class="card bg-base-100 shadow">
        <div class="card-body">
            <div class="flex items-center justify-between">
            <div>
              <div class="font-semibold">{{ s.order }}. {{ s.title }} <span class="badge badge-ghost ml-2">{{ step_percents.s.id }}%</span></div>
              {# Hide step details block because subtasks list below renders bullets #}
            </div>
            <div class="flex gap-2">
              {% if s.status != 'completed' and s.status != 'blocked' %}
                <a class="btn btn-xs" href="{% url 'process_creator:job_step_start' job.id s.id %}">Start</a>
                <a class="btn btn-xs btn-success" href="{% url 'process_creator:job_step_complete' job.id s.id %}">Complete</a>
                <a class="btn btn-xs btn-warning" href="{% url 'process_creator:job_step_block' job.id s.id %}">Block</a>
              {% elif s.status == 'blocked' %}
                <a class="btn btn-xs" href="{% url 'process_creator:job_step_unblock' job.id s.id %}">Unblock</a>
              {% endif %}
              <div class="badge">{{ s.get_status_display }}</div>
              {% with n=source_image_counts|dict_get:s.order %}
                {% if n %}
                  <button type="button" class="btn btn-xs js-toggle-images" data-step="{{ s.order }}">View Images ({{ n }})</button>
                {% endif %}
              {% endwith %}
            </div>
          </div>

          {% if s.subtasks.all %}
            <ul class="mt-3 space-y-1">
              {% for t in s.subtasks.all %}
                {% with substep_index=forloop.counter0 %}
                <li>
                  <label class="label cursor-pointer justify-start gap-2">
                    <input type="checkbox" class="checkbox checkbox-sm js-subtask" data-id="{{ t.id }}" {% if t.completed %}checked{% endif %}>
                    <span>{{ t.text }}</span>
                    <div class="flex gap-1 ml-auto">
                      {% with src=source_by_order|dict_get:s.order %}
                        {% if src and src|has_sub_images:substep_index %}
                          <button type="button" class="btn btn-ghost btn-xs js-toggle-images" data-step="{{ s.order }}" data-sub="{{ substep_index }}">Images</button>
                        {% endif %}
                      {% endwith %}
                      <button type="button" class="btn btn-ghost btn-xs js-paste-subtask-image" data-step="{{ s.id }}" data-subtask="{{ substep_index }}" title="Paste image for this subtask">ðŸ“‹</button>
                    </div>
                  </label>
                  
                  <!-- Images for this specific substep -->
                  {% with src=source_by_order|dict_get:s.order %}
                    {% if src and src|has_sub_images:substep_index %}
                      <div class="ml-6 mt-2 js-substep-images" data-step="{{ s.order }}" data-sub="{{ substep_index }}">
                        <div class="text-xs text-gray-500 mb-2">DEBUG: Step {{ s.order }}, Substep {{ substep_index }}, Has images: {{ src|has_sub_images:substep_index }}</div>
                        <div class="grid grid-cols-4 md:grid-cols-6 gap-2">
                          {% for img in src.images.all %}
                            {% if img.substep_index == substep_index %}
                              <figure class="border rounded p-1 cursor-pointer js-thumb" data-sub="{% if img.substep_index is not None %}{{ img.substep_index }}{% else %}{% endif %}" data-full="{{ img.image.url }}">
                                <img src="{{ img.image.url }}" class="w-full h-20 object-cover rounded" />
                              </figure>
                            {% endif %}
                          {% endfor %}
                        </div>
                      </div>
                    {% endif %}
                  {% endwith %}
                </li>
                {% endwith %}
              {% endfor %}
            </ul>
          {% endif %}

          <div class="mt-3 grid grid-cols-1 md:grid-cols-3 gap-3">
            <div>
              <label class="label"><span class="label-text">Paste Images</span></label>
              <div class="flex items-center gap-2">
                <button type="button" class="btn btn-sm js-paste-image" data-step="{{ s.id }}" title="Paste from Clipboard">ðŸ“‹ Paste</button>
                <input type="file" accept="image/*" class="file-input file-input-sm file-input-bordered js-upload-file" data-step="{{ s.id }}" />
              </div>
              <div class="mt-2 flex flex-wrap gap-2 js-thumbs" data-step="{{ s.id }}">
                {% for im in s.images.all %}
                  <div class="relative group">
                    <img src="{{ im.image.url }}" class="w-20 h-20 object-cover rounded cursor-pointer js-thumb border border-base-300" data-full="{{ im.image.url }}" />
                    <button class="btn btn-xs btn-error absolute -top-2 -right-2 hidden group-hover:block js-del-thumb" data-step="{{ s.id }}" data-img="{{ im.id }}">âœ•</button>
                  </div>
                {% endfor %}
              </div>
            </div>
            <div>
              <label class="label"><span class="label-text">File Attachments</span></label>
              <div class="flex items-center gap-2">
                <button type="button" class="btn btn-sm js-paste-file" data-step="{{ s.id }}" title="Paste File from Clipboard">ðŸ“Ž Paste</button>
                <input type="file" accept=".docx,.doc,.xlsx,.xls,.dwg,.idw,.pdf" class="file-input file-input-sm file-input-bordered js-upload-attachment" data-step="{{ s.id }}" />
              </div>
              <div class="mt-2 flex flex-wrap gap-2 js-attachments" data-step="{{ s.id }}">
                {% for att in s.attachments.all %}
                  <div class="relative group bg-base-100 border border-base-300 rounded p-2 min-w-32">
                    <div class="flex items-center gap-2">
                      <span class="text-lg">{{ att.icon|default:"ðŸ“Ž" }}</span>
                      <div class="flex-1 min-w-0">
                        <div class="text-xs font-medium truncate" title="{{ att.original_name }}">{{ att.original_name }}</div>
                        <div class="text-xs text-base-content/60">{{ att.file_size|default:"Unknown size" }}</div>
                      </div>
                      <button class="btn btn-xs btn-error js-del-attachment" data-step="{{ s.id }}" data-att="{{ att.id }}">âœ•</button>
                    </div>
                    {% if att.has_preview %}
                      <div class="mt-1">
                        <button class="btn btn-xs btn-primary js-view-preview" data-url="{{ att.pdf_preview.url }}">View PDF</button>
                        <a href="{{ att.file.url }}" class="btn btn-xs btn-outline" download="{{ att.original_name }}">Download</a>
                      </div>
                    {% elif att.conversion_status == 'failed' %}
                      <div class="mt-1">
                        <span class="text-xs text-warning">PDF conversion failed</span>
                        <a href="{{ att.file.url }}" class="btn btn-xs btn-outline" download="{{ att.original_name }}">Download Original</a>
                      </div>
                    {% else %}
                      <div class="mt-1">
                        <a href="{{ att.file.url }}" class="btn btn-xs btn-outline" download="{{ att.original_name }}">Download</a>
                      </div>
                    {% endif %}
                  </div>
                {% endfor %}
              </div>
            </div>
            <div>
              <label class="label"><span class="label-text">Notes</span></label>
              <textarea class="textarea textarea-bordered w-full js-notes" data-step="{{ s.id }}" rows="3" placeholder="Notes (use '-' for bullet lines)">{{ s.notes }}</textarea>
            </div>
          </div>

        </div>
      </div>
    {% endfor %}
  </div>
<script>
document.querySelectorAll('.js-subtask').forEach(cb=>{
  cb.addEventListener('change', async (e)=>{
    const id = e.target.dataset.id;
    const form = new FormData();
    form.append('completed', e.target.checked ? '1':'0');
    const res = await fetch('{% url "process_creator:job_subtask_toggle" 0 %}'.replace('0', id), {method:'POST', headers:{'X-CSRFToken': (document.cookie.split('csrftoken=')[1]||'').split(';')[0]}, body: form});
    if (res.ok) {
      // Reload to refresh progress badges; could be optimized to update inline
      window.location.reload();
    }
  });
});

// Initialize all substep images as hidden by default
document.querySelectorAll('.js-substep-images').forEach(panel=>{
  panel.classList.add('hidden');
});

document.querySelectorAll('.js-toggle-images').forEach(btn=>{
  btn.addEventListener('click', (e)=>{
    const step = e.currentTarget.dataset.step;
    const sub = e.currentTarget.dataset.sub;
    
    // Check if this is a substep image button
    if (sub !== undefined && sub !== '') {
      // Handle substep images
      const substepContainer = document.querySelector(`.js-substep-images[data-step="${step}"][data-sub="${sub}"]`);
      if (substepContainer) {
        // Hide all other substep image panels
        document.querySelectorAll('.js-substep-images').forEach(panel=>{
          if (panel !== substepContainer) panel.classList.add('hidden');
        });
        // Reset all button texts
        document.querySelectorAll('.js-toggle-images').forEach(b=>{
          b.textContent = b.textContent.replace('Hide', 'View').replace('Images', 'Images');
        });
        // Toggle this substep's images
        substepContainer.classList.toggle('hidden');
        e.currentTarget.textContent = substepContainer.classList.contains('hidden') ? 'Images' : 'Hide Images';
      }
    } else {
      // Handle step-level images - show all substep images for this step
      const stepContainers = document.querySelectorAll(`.js-substep-images[data-step="${step}"]`);
      const hasVisibleImages = Array.from(stepContainers).some(panel => !panel.classList.contains('hidden'));
      
      if (hasVisibleImages) {
        // Hide all substep images for this step
        stepContainers.forEach(panel => panel.classList.add('hidden'));
        e.currentTarget.textContent = e.currentTarget.textContent.replace('Hide', 'View');
      } else {
        // Show all substep images for this step
        document.querySelectorAll('.js-substep-images').forEach(panel => panel.classList.add('hidden'));
        stepContainers.forEach(panel => panel.classList.remove('hidden'));
        e.currentTarget.textContent = e.currentTarget.textContent.replace('View', 'Hide');
      }
      
      // Reset other step buttons
      document.querySelectorAll('.js-toggle-images').forEach(b=>{
        if (!b.dataset.sub && b !== e.currentTarget) {
          b.textContent = b.textContent.replace('Hide', 'View');
        }
      });
    }
  });
});

// Fullscreen image viewer (full-screen with wheel zoom)
const imgOverlay = (()=>{
  const overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.92);display:none;z-index:9999;';
  const scroller = document.createElement('div');
  scroller.style.cssText = 'position:absolute;inset:0;overflow:auto;cursor:zoom-out;';
  const img = document.createElement('img');
  img.id = 'js-full-img';
  img.style.cssText = 'display:block;margin:auto;transform-origin:center center;max-width:none;max-height:none;width:100%;height:auto;';
  scroller.appendChild(img);
  overlay.appendChild(scroller);
  document.body.appendChild(overlay);
  let scale = 1;
  function applyScale(){ img.style.width = (scale*100) + '%'; }
  function open(src){ img.src = src; scale = 1; applyScale(); overlay.style.display='block'; scroller.scrollTop = 0; scroller.scrollLeft = 0; }
  function close(){ overlay.style.display='none'; }
  overlay.addEventListener('click', close);
  // Alt+wheel to zoom; plain wheel scrolls within scroller
  overlay.addEventListener('wheel', (e)=>{
    if (!e.altKey) return; // allow normal scroll
    e.preventDefault();
    const delta = e.deltaY < 0 ? 0.1 : -0.1;
    scale = Math.max(0.2, Math.min(5, scale + delta));
    applyScale();
  }, {passive:false});
  return {open, close};
})();

// Delegated preview for source step images
// Click handlers for source process images (removed - now using substep images only)

// Delegated preview for uploaded thumbnails
document.querySelectorAll('.js-thumbs').forEach(container=>{
  container.addEventListener('click', (e)=>{
    if (e.target.closest('.js-del-thumb')) return;
    const img = e.target.closest('img');
    if (img) imgOverlay.open(img.getAttribute('src'));
  });
});

// Delegated preview for substep images
document.querySelectorAll('.js-substep-images').forEach(container=>{
  container.addEventListener('click', (e)=>{
    if (e.target.closest('.js-del-thumb')) return;
    const img = e.target.closest('img');
    if (img) imgOverlay.open(img.getAttribute('src'));
  });
});

// Notes autosave (debounced)
document.querySelectorAll('.js-notes').forEach(area=>{
  let t;
  area.addEventListener('input', ()=>{
    clearTimeout(t);
    t = setTimeout(async ()=>{
      const id = area.dataset.step;
      const form = new FormData(); form.append('notes', area.value);
      await fetch('{% url "process_creator:job_step_notes_update" 0 %}'.replace('0', id), {method:'POST', headers:{'X-CSRFToken': (document.cookie.split('csrftoken=')[1]||'').split(';')[0]}, body: form});
    }, 400);
  });
});

// Paste/upload images to step
async function uploadImageToStep(stepId, file, subIdx){
  const form = new FormData();
  form.append('image', file);
  if (subIdx !== undefined && subIdx !== null) form.append('subtask_index', subIdx);
  const res = await fetch('{% url "process_creator:job_step_image_upload" 0 %}'.replace('0', stepId), {method:'POST', headers:{'X-CSRFToken': (document.cookie.split('csrftoken=')[1]||'').split(';')[0]}, body: form});
  const data = await res.json();
  if (data.ok) {
    const thumbs = document.querySelector(`.js-thumbs[data-step="${stepId}"]`);
    if (thumbs) {
      const wrap = document.createElement('div');
      wrap.className = 'relative group';
      
      // Create image element to get dimensions
      const img = new Image();
      img.onload = function() {
        const aspectRatio = this.width / this.height;
        const maxSize = 80; // Base size
        let width, height;
        
        if (aspectRatio > 1) {
          // Landscape - width is max
          width = maxSize;
          height = maxSize / aspectRatio;
        } else {
          // Portrait or square - height is max
          height = maxSize;
          width = maxSize * aspectRatio;
        }
        
        // Ensure minimum size
        const minSize = 40;
        if (width < minSize) {
          width = minSize;
          height = minSize / aspectRatio;
        }
        if (height < minSize) {
          height = minSize;
          width = minSize * aspectRatio;
        }
        
        wrap.innerHTML = `<img src="${data.url}" class="object-cover rounded cursor-pointer js-thumb border border-base-300" data-full="${data.url}" style="width: ${width}px; height: ${height}px;" />
                          <button class="btn btn-xs btn-error absolute -top-2 -right-2 hidden group-hover:block js-del-thumb" data-step="${stepId}" data-img="${data.id}">âœ•</button>`;
        thumbs.appendChild(wrap);
      };
      img.src = data.url;
    }
    // Show a brief success message for subtask images
    if (subIdx !== null && subIdx !== undefined) {
      const toast = document.createElement('div');
      toast.className = 'toast toast-top toast-end';
      toast.innerHTML = '<div class="alert alert-success"><span>Image attached to subtask ' + (subIdx + 1) + '</span></div>';
      document.body.appendChild(toast);
      setTimeout(()=>toast.remove(), 2000);
    }
  }
}

document.querySelectorAll('.js-upload-file').forEach(inp=>{
  inp.addEventListener('change', async (e)=>{
    const file = e.target.files[0]; if (!file) return;
    const stepId = e.target.dataset.step;
    await uploadImageToStep(stepId, file, null);
    e.target.value = '';
  });
});

document.querySelectorAll('.js-paste-image').forEach(btn=>{
  btn.addEventListener('click', async ()=>{
    try {
      const items = await navigator.clipboard.read();
      for (const it of items) {
        for (const type of it.types) {
          if (type.startsWith('image/')) {
            const blob = await it.getType(type);
            const file = new File([blob], 'pasted.png', {type});
            await uploadImageToStep(btn.dataset.step, file, null);
            return;
          }
        }
      }
      alert('No image found in clipboard. Use the file picker or copy an image first.');
    } catch (err) {
      alert('Clipboard image read not supported. Try the file picker.');
    }
  });
});

// Paste image for specific subtask
document.querySelectorAll('.js-paste-subtask-image').forEach(btn=>{
  btn.addEventListener('click', async ()=>{
    try {
      const items = await navigator.clipboard.read();
      for (const it of items) {
        for (const type of it.types) {
          if (type.startsWith('image/')) {
            const blob = await it.getType(type);
            const file = new File([blob], 'pasted.png', {type});
            const stepId = btn.dataset.step;
            const subtaskIndex = parseInt(btn.dataset.subtask);
            await uploadImageToStep(stepId, file, subtaskIndex);
            return;
          }
        }
      }
      alert('No image found in clipboard. Use the file picker or copy an image first.');
    } catch (err) {
      alert('Clipboard image read not supported. Try the file picker.');
    }
  });
});

// Delete thumbnails
document.querySelectorAll('.js-del-thumb').forEach(btn=>{
  btn.addEventListener('click', async (e)=>{
    e.stopPropagation();
    const stepId = btn.dataset.step;
    const imgId = btn.dataset.img;
    console.log('Deleting image:', stepId, imgId); // Debug log
    const url = `/process-creator/steps/${stepId}/images/${imgId}/delete/`;
    console.log('Delete URL:', url); // Debug log
    const res = await fetch(url, {method:'POST', headers:{'X-CSRFToken': (document.cookie.split('csrftoken=')[1]||'').split(';')[0]}});
    if (res.ok) {
      const wrapper = btn.parentElement; wrapper.remove();
    } else {
      console.error('Delete failed:', res.status, res.statusText);
    }
  });
});

// Resize existing thumbnails proportionally
document.querySelectorAll('.js-thumb').forEach(img => {
  img.onload = function() {
    const aspectRatio = this.naturalWidth / this.naturalHeight;
    const maxSize = 80; // Base size
    let width, height;
    
    if (aspectRatio > 1) {
      // Landscape - width is max
      width = maxSize;
      height = maxSize / aspectRatio;
    } else {
      // Portrait or square - height is max
      height = maxSize;
      width = maxSize * aspectRatio;
    }
    
    // Ensure minimum size
    const minSize = 40;
    if (width < minSize) {
      width = minSize;
      height = minSize / aspectRatio;
    }
    if (height < minSize) {
      height = minSize;
      width = minSize * aspectRatio;
    }
    
    this.style.width = width + 'px';
    this.style.height = height + 'px';
  };
  
  // Trigger onload if image is already loaded
  if (img.complete) {
    img.onload();
  }
});

// File attachment functionality
document.querySelectorAll('.js-upload-attachment').forEach(input => {
  input.addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    const stepId = e.target.dataset.step;
    const form = new FormData();
    form.append('file', file);
    
    try {
      const res = await fetch(`/process-creator/steps/${stepId}/attachments/upload/`, {
        method: 'POST',
        headers: {'X-CSRFToken': (document.cookie.split('csrftoken=')[1]||'').split(';')[0]},
        body: form
      });
      
      const data = await res.json();
      if (data.ok) {
        addAttachmentChip(stepId, data);
        e.target.value = ''; // Clear input
      } else {
        alert('Upload failed: ' + (data.error || 'Unknown error'));
      }
    } catch (err) {
      console.error('Upload error:', err);
      alert('Upload failed: ' + err.message);
    }
  });
});

// Paste file from clipboard
document.querySelectorAll('.js-paste-file').forEach(btn => {
  btn.addEventListener('click', async (e) => {
    const stepId = e.target.dataset.step;
    
    try {
      const clipboardItems = await navigator.clipboard.read();
      let fileFound = false;
      
      for (const clipboardItem of clipboardItems) {
        for (const type of clipboardItem.types) {
          if (type.startsWith('application/') || type.startsWith('image/')) {
            const blob = await clipboardItem.getType(type);
            const file = new File([blob], `pasted_file_${Date.now()}.${type.split('/')[1]}`, { type });
            
            const form = new FormData();
            form.append('file', file);
            
            const res = await fetch(`/process-creator/steps/${stepId}/attachments/upload/`, {
              method: 'POST',
              headers: {'X-CSRFToken': (document.cookie.split('csrftoken=')[1]||'').split(';')[0]},
              body: form
            });
            
            const data = await res.json();
            if (data.ok) {
              addAttachmentChip(stepId, data);
              fileFound = true;
            }
          }
        }
      }
      
      if (!fileFound) {
        alert('No supported files found in clipboard');
      }
    } catch (err) {
      console.error('Paste error:', err);
      alert('Paste failed: ' + err.message);
    }
  });
});

// Delete attachments
document.querySelectorAll('.js-del-attachment').forEach(btn => {
  btn.addEventListener('click', async (e) => {
    e.stopPropagation();
    const stepId = btn.dataset.step;
    const attId = btn.dataset.att;
    
    const res = await fetch(`/process-creator/steps/${stepId}/attachments/${attId}/delete/`, {
      method: 'POST',
      headers: {'X-CSRFToken': (document.cookie.split('csrftoken=')[1]||'').split(';')[0]}
    });
    
    if (res.ok) {
      btn.closest('.group').remove();
    } else {
      console.error('Delete failed:', res.status, res.statusText);
    }
  });
});

// View PDF preview
document.querySelectorAll('.js-view-preview').forEach(btn => {
  btn.addEventListener('click', (e) => {
    const url = e.target.dataset.url;
    window.open(url, '_blank');
  });
});

// Helper function to add attachment chip
function addAttachmentChip(stepId, data) {
  const container = document.querySelector(`.js-attachments[data-step="${stepId}"]`);
  if (!container) return;
  
  const chip = document.createElement('div');
  chip.className = 'relative group bg-base-100 border border-base-300 rounded p-2 min-w-32';
  chip.innerHTML = `
    <div class="flex items-center gap-2">
      <span class="text-lg">${data.icon || 'ðŸ“Ž'}</span>
      <div class="flex-1 min-w-0">
        <div class="text-xs font-medium truncate" title="${data.original_name}">${data.original_name}</div>
        <div class="text-xs text-base-content/60">${data.file_size || 'Unknown size'}</div>
      </div>
      <button class="btn btn-xs btn-error js-del-attachment" data-step="${stepId}" data-att="${data.id}">âœ•</button>
    </div>
    <div class="mt-1">
      ${data.has_preview ? `<button class="btn btn-xs btn-primary js-view-preview" data-url="${data.preview_url}">View PDF</button>` : ''}
      <a href="${data.url}" class="btn btn-xs btn-outline" download="${data.original_name}">Download</a>
    </div>
  `;
  
  // Add event listeners to new buttons
  chip.querySelector('.js-del-attachment').addEventListener('click', async (e) => {
    e.stopPropagation();
    const attId = e.target.dataset.att;
    const res = await fetch(`/process-creator/steps/${stepId}/attachments/${attId}/delete/`, {
      method: 'POST',
      headers: {'X-CSRFToken': (document.cookie.split('csrftoken=')[1]||'').split(';')[0]}
    });
    if (res.ok) {
      chip.remove();
    }
  });
  
  if (data.has_preview) {
    chip.querySelector('.js-view-preview').addEventListener('click', (e) => {
      window.open(e.target.dataset.url, '_blank');
    });
  }
  
  container.appendChild(chip);
}

// Note: Word downloads are handled by the browser. To auto-open, enable
// the browser's setting to "Always open files of this type" for .docx.
</script>
</div>
{% endblock %}

