{% extends 'base.html' %}
{% block title %}Process Creator{% endblock %}
{% block content %}
<div class="flex items-center justify-between mb-6">
  <h1 class="text-2xl font-bold">Process Creator</h1>
  <div class="flex gap-2">
    <button id="summary-all" class="btn btn-secondary">Summary All</button>
    <button id="analyze-all" class="btn btn-accent">Analysis All</button>
    <button id="print-all" class="btn">Print All</button>
    <button id="export-pdf-all" class="btn btn-outline">Export PDF</button>
    <button id="export-word-all" class="btn btn-outline">Export Word</button>
    <a href="{% url 'process_creator:create' %}" class="btn btn-primary">New Process</a>
  </div>
  </div>

<!-- Module Filter -->
<div class="mb-6">
  <div class="flex items-center gap-4">
    <label for="module-filter" class="text-sm font-medium">Filter by Module:</label>
    <select id="module-filter" class="select select-bordered w-full max-w-xs">
      <option value="">All Modules</option>
      {% for module in modules %}
        <option value="{{ module.id }}" {% if selected_module and selected_module.id == module.id %}selected{% endif %}>
          {{ module.name }}
        </option>
      {% endfor %}
      <option value="__new__">+ New Moduleâ€¦</option>
    </select>
    {% if selected_module %}
      <div class="text-sm text-base-content/70">
        Showing processes in: <strong>{{ selected_module.name }}</strong>
      </div>
    {% endif %}
  </div>
</div>

<div id="process-list" class="grid gap-3">
  {% for p in processes %}
    <div class="card bg-base-200 shadow-sm" data-id="{{ p.id }}">
      <div class="card-body py-3 px-4">
        <div class="flex items-center justify-between gap-3">
          <div class="flex items-center gap-3">
            <input type="checkbox" class="select-item checkbox checkbox-primary" checked />
            <span class="drag cursor-grab text-base-content/60" title="Drag to reorder" aria-label="Drag to reorder">
              <!-- grip-vertical icon -->
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="h-5 w-5">
                <path d="M7 5a1 1 0 1 1-2 0 1 1 0 0 1 2 0Zm8 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0ZM7 10a1 1 0 1 1-2 0 1 1 0 0 1 2 0Zm8 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0ZM7 15a1 1 0 1 1-2 0 1 1 0 0 1 2 0Zm8 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"/>
              </svg>
            </span>
            <div>
              <div class="font-semibold">{{ p.name }}</div>
              <div class="text-xs opacity-70">Updated {{ p.updated_at|date:'Y-m-d H:i' }}</div>
            </div>
          </div>
          <div class="flex gap-2">
            <a class="btn btn-sm" href="{% url 'process_creator:edit' p.id %}">Edit</a>
            <a class="btn btn-sm" href="{% url 'process_creator:print' p.id %}" target="_blank">Print</a>
            <button class="btn btn-sm" onclick="copyProcess({{ p.id }})">Copy</button>
            <a class="btn btn-sm btn-error" href="{% url 'process_creator:delete' p.id %}">Delete</a>
          </div>
        </div>
      </div>
    </div>
  {% empty %}
    <div class="alert">No processes yet. Create one to get started.</div>
  {% endfor %}
</div>

        <!-- History Section -->
        <div class="mt-8">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold">History</h2>
                <div class="flex gap-2">
                    <button id="export-history-pdf" class="btn btn-outline btn-sm">Export PDF</button>
                    <button id="export-history-word" class="btn btn-outline btn-sm">Export Word</button>
                </div>
            </div>
            <div id="analysis-history" class="space-y-3">
                <!-- History items will be populated by JavaScript -->
            </div>
        </div>

{% endblock %}

{% block extra_js %}
<script>
function getCookie(name){
  const value = `; ${document.cookie}`.split(`; ${name}=`).pop();
  return value ? value.split(';').shift() : '';
}

// Drag reorder
let dragEl = null;
document.querySelectorAll('#process-list .card').forEach(card=>{
  const handle = card.querySelector('.drag');
  card.draggable = true;
  card.addEventListener('dragstart', ()=>{ dragEl = card; card.classList.add('opacity-50'); });
  card.addEventListener('dragend', ()=>{ card.classList.remove('opacity-50'); dragEl = null; saveOrder(); });
});
document.getElementById('process-list').addEventListener('dragover', (e)=>{
  e.preventDefault();
  const container = e.currentTarget;
  const afterEl = Array.from(container.querySelectorAll('.card')).find(el=>{
    const rect = el.getBoundingClientRect();
    return e.clientY < rect.top + rect.height/2;
  });
  if (!afterEl) container.appendChild(dragEl); else container.insertBefore(dragEl, afterEl);
});

function saveOrder(){
  const ids = Array.from(document.querySelectorAll('#process-list .card')).map(c=>c.dataset.id);
  const form = new URLSearchParams(); ids.forEach(id=>form.append('order[]', id));
  fetch('{% url "process_creator:reorder" %}', {method:'POST', headers:{'X-CSRFToken': getCookie('csrftoken')}, body:form});
}

// Print all or selected
document.getElementById('print-all').addEventListener('click', ()=>{
  const ids = Array.from(document.querySelectorAll('#process-list .card'))
    .filter(c=>c.querySelector('.select-item').checked)
    .map(c=>c.dataset.id);
  const params = new URLSearchParams(); ids.forEach(id=>params.append('ids', id));
  window.open('{% url "process_creator:print_all" %}?'+params.toString(), '_blank');
});

// Bulk AI operations
document.getElementById('summary-all').addEventListener('click', async ()=>{
  const ids = Array.from(document.querySelectorAll('#process-list .card'))
    .filter(c=>c.querySelector('.select-item').checked)
    .map(c=>c.dataset.id);
  if (ids.length === 0) {
    showToast('Please select at least one process', 'error');
    return;
  }
  
  const btn = document.getElementById('summary-all');
  const originalText = btn.innerHTML;
  try {
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Generating...';
    
    const res = await fetch('{% url "process_creator:bulk_summary" %}', {
      method: 'POST',
      headers: {'X-CSRFToken': getCookie('csrftoken'), 'Content-Type': 'application/json'},
      body: JSON.stringify({process_ids: ids})
    });
    
    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
    
    const data = await res.json();
    if (data.success) {
      // Add to history
      addToHistory('Summary', data.summary, new Date());
      
      const toast = document.createElement('div');
      toast.className = 'toast toast-top toast-end';
      toast.innerHTML = '<div class="alert alert-success"><span>Bulk summary generated successfully!</span></div>';
      document.body.appendChild(toast);
      setTimeout(()=>toast.remove(), 3000);
    } else {
      throw new Error(data.error || 'Failed to generate bulk summary');
    }
  } catch(err) {
    const toast = document.createElement('div');
    toast.className = 'toast toast-top toast-end';
    toast.innerHTML = '<div class="alert alert-error"><span>Failed to generate bulk summary: ' + err.message + '</span></div>';
    document.body.appendChild(toast);
    setTimeout(()=>toast.remove(), 5000);
  } finally {
    btn.disabled = false;
    btn.innerHTML = originalText;
  }
});

document.getElementById('analyze-all').addEventListener('click', async ()=>{
  const ids = Array.from(document.querySelectorAll('#process-list .card'))
    .filter(c=>c.querySelector('.select-item').checked)
    .map(c=>c.dataset.id);
  if (ids.length === 0) {
    showToast('Please select at least one process', 'error');
    return;
  }
  
  const btn = document.getElementById('analyze-all');
  const originalText = btn.innerHTML;
  try {
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Analyzing...';
    
    const res = await fetch('{% url "process_creator:bulk_analyze" %}', {
      method: 'POST',
      headers: {'X-CSRFToken': getCookie('csrftoken'), 'Content-Type': 'application/json'},
      body: JSON.stringify({process_ids: ids})
    });
    
    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
    
    const data = await res.json();
    if (data.success) {
      // Add to history
      addToHistory('Analysis', data.analysis, new Date());
      
      const toast = document.createElement('div');
      toast.className = 'toast toast-top toast-end';
      toast.innerHTML = '<div class="alert alert-success"><span>Bulk analysis completed successfully!</span></div>';
      document.body.appendChild(toast);
      setTimeout(()=>toast.remove(), 3000);
    } else {
      throw new Error(data.error || 'Failed to generate bulk analysis');
    }
  } catch(err) {
    const toast = document.createElement('div');
    toast.className = 'toast toast-top toast-end';
    toast.innerHTML = '<div class="alert alert-error"><span>Failed to generate bulk analysis: ' + err.message + '</span></div>';
    document.body.appendChild(toast);
    setTimeout(()=>toast.remove(), 5000);
  } finally {
    btn.disabled = false;
    btn.innerHTML = originalText;
  }
});

// Module filter
document.getElementById('module-filter').addEventListener('change', (e) => {
  const moduleId = e.target.value;
  if (moduleId === '__new__') {
    // Open create module modal
    openCreateModuleModal({ afterCreate: (mod)=>{
      // Insert new option and select it
      const sel = document.getElementById('module-filter');
      const opt = document.createElement('option');
      opt.value = mod.id; opt.textContent = mod.name;
      sel.insertBefore(opt, sel.querySelector('option[value="__new__"]'));
      sel.value = mod.id;
      // Navigate with module param
      const url = new URL(window.location);
      url.searchParams.set('module', mod.id);
      window.location.href = url.toString();
    }});
    // Revert selection to previous while modal is open
    const url = new URL(window.location);
    const current = url.searchParams.get('module') || '';
    e.target.value = current;
    return;
  }
  const url = new URL(window.location);
  if (moduleId) {
    url.searchParams.set('module', moduleId);
  } else {
    url.searchParams.delete('module');
  }
  window.location.href = url.toString();
});

// Minimal create-module modal (DaisyUI)
function openCreateModuleModal({afterCreate}={}){
  let modal = document.getElementById('create-module-modal');
  if (!modal) {
    modal = document.createElement('dialog');
    modal.id = 'create-module-modal';
    modal.className = 'modal';
    modal.innerHTML = `
      <div class="modal-box">
        <h3 class="font-bold text-lg mb-3">Create Module</h3>
        <div class="form-control mb-2">
          <label class="label"><span class="label-text">Name</span></label>
          <input id="new-module-name" class="input input-bordered" placeholder="e.g., Engineering/Drafting" />
        </div>
        <div class="form-control mb-4">
          <label class="label"><span class="label-text">Description (optional)</span></label>
          <textarea id="new-module-desc" class="textarea textarea-bordered" rows="3" placeholder="Short description"></textarea>
        </div>
        <div class="modal-action">
          <button id="create-module-cancel" class="btn btn-ghost">Cancel</button>
          <button id="create-module-save" class="btn btn-primary">Create</button>
        </div>
      </div>`;
    document.body.appendChild(modal);
  }
  modal.showModal();
  modal.querySelector('#create-module-cancel').onclick = ()=> modal.close();
  modal.querySelector('#create-module-save').onclick = async ()=>{
    const name = modal.querySelector('#new-module-name').value.trim();
    const description = modal.querySelector('#new-module-desc').value.trim();
    if (!name) { showToast('Module name is required', 'error'); return; }
    try {
      const res = await fetch('{% url "process_creator:module_create" %}', {
        method: 'POST',
        headers: {'X-CSRFToken': getCookie('csrftoken'), 'Content-Type': 'application/json'},
        body: JSON.stringify({name, description})
      });
      const data = await res.json();
      if (!res.ok || !data.ok) throw new Error(data.error || 'Failed to create module');
      modal.close();
      showToast('Module created', 'success');
      afterCreate && afterCreate({id: data.id, name: data.name});
    } catch(err) {
      console.error(err);
      showToast(err.message, 'error');
    }
  };
}

// Export functions
document.getElementById('export-pdf-all').addEventListener('click', ()=>{
  const ids = Array.from(document.querySelectorAll('#process-list .card'))
    .filter(c=>c.querySelector('.select-item').checked)
    .map(c=>c.dataset.id);
  if (ids.length === 0) {
    showToast('Please select at least one process', 'error');
    return;
  }
  const selectedHistory = getSelectedHistoryItems();
  const params = new URLSearchParams(); 
  ids.forEach(id=>params.append('ids', id));
  
  // Add module filter if selected
  const selectedModule = document.getElementById('module-filter').value;
  if (selectedModule) {
    params.append('module', selectedModule);
  }
  
  if (selectedHistory.length > 0) {
    params.append('include_history', 'true');
    params.append('history_data', JSON.stringify(selectedHistory));
  }
  window.open('{% url "process_creator:bulk_pdf" %}?'+params.toString(), '_blank');
});

document.getElementById('export-word-all').addEventListener('click', ()=>{
  const ids = Array.from(document.querySelectorAll('#process-list .card'))
    .filter(c=>c.querySelector('.select-item').checked)
    .map(c=>c.dataset.id);
  if (ids.length === 0) {
    showToast('Please select at least one process', 'error');
    return;
  }
  const selectedHistory = getSelectedHistoryItems();
  const params = new URLSearchParams(); 
  ids.forEach(id=>params.append('ids', id));
  
  // Add module filter if selected
  const selectedModule = document.getElementById('module-filter').value;
  if (selectedModule) {
    params.append('module', selectedModule);
  }
  
  if (selectedHistory.length > 0) {
    params.append('include_history', 'true');
    params.append('history_data', JSON.stringify(selectedHistory));
  }
  window.open('{% url "process_creator:bulk_word" %}?'+params.toString(), '_blank');
});

// History management
function addToHistory(type, content, date) {
  const history = JSON.parse(localStorage.getItem('bulkAnalysisHistory') || '[]');
  history.unshift({
    type: type,
    content: content,
    date: date.toISOString(),
    id: Date.now()
  });
  // Keep only last 10 entries
  if (history.length > 10) history.splice(10);
  localStorage.setItem('bulkAnalysisHistory', JSON.stringify(history));
  renderHistory();
}

function renderHistory() {
  const history = JSON.parse(localStorage.getItem('bulkAnalysisHistory') || '[]');
  const container = document.getElementById('analysis-history');
  if (!container) return;
  
  if (history.length === 0) {
    container.innerHTML = '<p class="text-center text-gray-500 py-4">No bulk analyses yet</p>';
    return;
  }
  
  container.innerHTML = history.map(item => `
    <div class="card bg-base-100 shadow-sm mb-3">
      <div class="card-body py-3 px-4">
        <div class="flex items-start gap-3">
          <label class="flex items-center">
            <input type="checkbox" class="checkbox checkbox-primary history-checkbox" data-id="${item.id}" checked />
          </label>
          <div class="flex-1">
            <h4 class="font-semibold">${item.type} - ${new Date(item.date).toLocaleString()}</h4>
            <div class="text-sm text-gray-600 max-h-32 overflow-y-auto mt-1">${item.content.substring(0, 200)}${item.content.length > 200 ? '...' : ''}</div>
          </div>
          <div class="flex gap-1">
            <button onclick="printHistoryItem(${item.id})" class="btn btn-ghost btn-sm" title="Print">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2z"></path>
              </svg>
            </button>
            <button onclick="copyHistoryItem(${item.id})" class="btn btn-ghost btn-sm" title="Copy to Clipboard">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
              </svg>
            </button>
            <button onclick="deleteHistoryItem(${item.id})" class="btn btn-ghost btn-sm text-error" title="Delete">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>
  `).join('');
}

function deleteHistoryItem(id) {
  const history = JSON.parse(localStorage.getItem('bulkAnalysisHistory') || '[]');
  const filtered = history.filter(item => item.id !== id);
  localStorage.setItem('bulkAnalysisHistory', JSON.stringify(filtered));
  renderHistory();
}

function printHistoryItem(id) {
  const history = JSON.parse(localStorage.getItem('bulkAnalysisHistory') || '[]');
  const item = history.find(h => h.id === id);
  if (!item) return;
  
  const printWindow = window.open('', '_blank');
  printWindow.document.write(`
    <html>
      <head>
        <title>${item.type} - ${new Date(item.date).toLocaleString()}</title>
        <style>
          body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
          h1 { color: #333; border-bottom: 2px solid #333; padding-bottom: 10px; }
          .content { white-space: pre-wrap; }
        </style>
      </head>
      <body>
        <h1>${item.type} - ${new Date(item.date).toLocaleString()}</h1>
        <div class="content">${item.content}</div>
      </body>
    </html>
  `);
  printWindow.document.close();
  printWindow.print();
}

function copyHistoryItem(id) {
  const history = JSON.parse(localStorage.getItem('bulkAnalysisHistory') || '[]');
  const item = history.find(h => h.id === id);
  if (!item) return;
  
  const text = `${item.type} - ${new Date(item.date).toLocaleString()}\n\n${item.content}`;
  navigator.clipboard.writeText(text).then(() => {
    showToast('Copied to clipboard', 'success');
  }).catch(err => {
    console.error('Failed to copy: ', err);
    showToast('Failed to copy to clipboard', 'error');
  });
}

// Checkbox state persistence
function saveCheckboxStates() {
  const states = {};
  document.querySelectorAll('.select-item').forEach(checkbox => {
    const processId = checkbox.closest('.card').dataset.id;
    states[processId] = checkbox.checked;
  });
  localStorage.setItem('processCheckboxStates', JSON.stringify(states));
}

function loadCheckboxStates() {
  const states = JSON.parse(localStorage.getItem('processCheckboxStates') || '{}');
  document.querySelectorAll('.select-item').forEach(checkbox => {
    const processId = checkbox.closest('.card').dataset.id;
    if (states.hasOwnProperty(processId)) {
      checkbox.checked = states[processId];
    }
  });
}

// Toast helper function
function showToast(message, type = 'success') {
  const toast = document.createElement('div');
  toast.className = 'toast toast-top toast-end';
  toast.innerHTML = `<div class="alert alert-${type}"><span>${message}</span></div>`;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), type === 'error' ? 5000 : 3000);
}

// Copy process function
async function copyProcess(processId) {
  try {
    const response = await fetch(`{% url 'process_creator:copy' 0 %}`.replace('0', processId));
    const text = await response.text();
    await navigator.clipboard.writeText(text);
    showToast('Copied Markdown to clipboard', 'success');
  } catch(err) {
    console.error('Failed to copy: ', err);
    showToast('Failed to copy to clipboard', 'error');
  }
}

// History export functions
document.getElementById('export-history-pdf').addEventListener('click', () => {
  const selectedHistory = getSelectedHistoryItems();
  if (selectedHistory.length === 0) {
    showToast('Please select at least one history item', 'error');
    return;
  }
  exportHistoryToPDF(selectedHistory);
});

document.getElementById('export-history-word').addEventListener('click', () => {
  const selectedHistory = getSelectedHistoryItems();
  if (selectedHistory.length === 0) {
    showToast('Please select at least one history item', 'error');
    return;
  }
  exportHistoryToWord(selectedHistory);
});

function getSelectedHistoryItems() {
  const history = JSON.parse(localStorage.getItem('bulkAnalysisHistory') || '[]');
  const selectedIds = Array.from(document.querySelectorAll('.history-checkbox:checked'))
    .map(cb => parseInt(cb.dataset.id));
  return history.filter(item => selectedIds.includes(item.id));
}

function exportHistoryToPDF(historyItems) {
  const printWindow = window.open('', '_blank');
  const content = historyItems.map(item => 
    `<div style="page-break-after: always; margin-bottom: 30px;">
      <h2>${item.type} - ${new Date(item.date).toLocaleString()}</h2>
      <div style="white-space: pre-wrap; line-height: 1.6;">${item.content}</div>
    </div>`
  ).join('');
  
  printWindow.document.write(`
    <html>
      <head>
        <title>History Export - ${new Date().toLocaleString()}</title>
        <style>
          body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
          h2 { color: #333; border-bottom: 1px solid #333; padding-bottom: 5px; margin-top: 30px; }
          @media print { body { margin: 15px; } }
        </style>
      </head>
      <body>
        <h1>History Export - ${new Date().toLocaleString()}</h1>
        ${content}
      </body>
    </html>
  `);
  printWindow.document.close();
  printWindow.print();
}

function exportHistoryToWord(historyItems) {
  // Create a simple text format that can be copied to Word
  const content = historyItems.map(item => 
    `${item.type} - ${new Date(item.date).toLocaleString()}\n${'='.repeat(50)}\n${item.content}\n\n`
  ).join('');
  
  const text = `History Export - ${new Date().toLocaleString()}\n${'='.repeat(60)}\n\n${content}`;
  
  navigator.clipboard.writeText(text).then(() => {
    showToast('History content copied to clipboard. Paste into Word document.', 'success');
  }).catch(err => {
    console.error('Failed to copy: ', err);
    showToast('Failed to copy to clipboard', 'error');
  });
}

// Add event listeners to checkboxes
document.addEventListener('DOMContentLoaded', () => {
  loadCheckboxStates();
  document.querySelectorAll('.select-item').forEach(checkbox => {
    checkbox.addEventListener('change', saveCheckboxStates);
  });
});

// Load history on page load
document.addEventListener('DOMContentLoaded', renderHistory);
</script>
{% endblock %}


