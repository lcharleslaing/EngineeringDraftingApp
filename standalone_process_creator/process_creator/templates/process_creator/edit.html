{% extends 'process_creator/base.html' %}
{% load process_filters %}
{% block title %}Edit: {{ process.name }}{% endblock %}
{% block content %}
<div class="sticky top-0 z-10 bg-base-100/90 backdrop-blur border-b border-base-200 mb-6">
  <div class="max-w-7xl mx-auto px-1 sm:px-2 lg:px-4 py-3">
    <div class="flex items-center gap-3 mb-3">
      <input id="process-name" class="input input-bordered w-full" value="{{ process.name }}" placeholder="Process name" required />
      <select id="process-module" class="select select-bordered w-full max-w-xs">
        <option value="">No Module</option>
        {% for module in modules %}
          <option value="{{ module.id }}" {% if process.module and process.module.id == module.id %}selected{% endif %}>{{ module.name }}</option>
        {% endfor %}
      </select>
      <button id="stats-btn" class="btn btn-outline btn-sm">
        <i class="fas fa-chart-bar mr-1"></i>Stats
      </button>
      <a href="{% url 'process_creator:list' %}" class="btn btn-ghost btn-sm">
        <i class="fas fa-arrow-left mr-1"></i>Back
      </a>
    </div>
  </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
  <!-- Summary & Analysis Section -->
  <div class="col-span-12">
    <div class="card bg-base-200 shadow-sm">
      <div class="card-body p-4">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div>
            <label class="label">
              <span class="label-text font-medium">Summary Instructions</span>
            </label>
            <textarea id="summary-instructions" class="textarea textarea-bordered w-full min-h-20 auto-resize" placeholder="Instructions for AI summary generation">{{ process.summary_instructions }}</textarea>
          </div>
          
          <div>
            <label class="label">
              <span class="label-text font-medium">Summary</span>
            </label>
            <textarea id="process-summary" class="textarea textarea-bordered w-full min-h-24 auto-resize" placeholder="AI-generated summary of the process">{{ process.summary }}</textarea>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-span-12">
    <h2 class="font-semibold mb-2">Description</h2>
    <textarea id="process-description" class="textarea textarea-bordered w-full min-h-28 auto-resize" placeholder="Describe the process">{{ process.description }}</textarea>
  </div>

  <div class="col-span-12">
    <div class="flex items-center justify-between mb-2">
      <h2 class="font-semibold">Steps</h2>
      <button id="add-step" class="btn btn-primary btn-sm">Add Step</button>
    </div>
    <div id="steps" class="space-y-4">
      {% for step in process.steps.all %}
        <div class="card bg-base-100 shadow-sm" data-id="{{ step.id }}">
          <div class="card-body p-4">
            <div class="flex items-center gap-3 mb-3">
              <input class="step-title input input-bordered flex-1" value="{{ step.title }}" placeholder="Step title" />
              <div class="flex gap-1">
                <button class="btn btn-sm btn-error step-delete">Delete</button>
              </div>
            </div>
            <textarea class="step-details textarea textarea-bordered mt-3 h-24 auto-resize" placeholder="Details">{{ step.details }}</textarea>
            
            <!-- Links -->
            <div class="mt-3">
              <div class="text-sm opacity-70 mb-1">Links</div>
              <div class="flex flex-wrap gap-2" id="links-{{ step.id }}">
                {% for link in step.links.all %}
                  <div class="relative group">
                    <a href="{{ link.url }}" target="_blank" class="btn btn-sm btn-outline">{{ link.title }}</a>
                    <button class="btn btn-xs btn-error absolute -top-1 -right-1 opacity-0 group-hover:opacity-100 delete-link" data-step="{{ step.id }}" data-id="{{ link.id }}">‚úï</button>
                  </div>
                {% endfor %}
              </div>
              <div class="mt-2">
                <button type="button" class="btn btn-sm" data-open-link-modal="{{ step.id }}">Add Link</button>
              </div>
            </div>

            <!-- Files -->
            <div class="mt-3">
              <div class="text-sm opacity-70 mb-1">Documents (paste or drop PDF / DWG / IDW)</div>
              <div class="grid grid-cols-2 md:grid-cols-3 gap-2" id="pdfs-{{ step.id }}">
                {% for f in step.files.all %}
                  <div class="relative group">
                    <div class="rounded border w-full h-28 bg-base-300/30 flex items-center justify-center cursor-pointer pdf-thumb" data-url="{{ f.file.url }}" data-name="{{ f.file.name|basename }} ({{ f.uploaded_at|date:'mdy-HisA' }})" title="{{ f.file.name|basename }}">
                      <span class="text-xs">PDF</span>
                    </div>
                    <button class="btn btn-xs btn-error absolute top-1 right-1 opacity-0 group-hover:opacity-100 delete-pdf" data-step="{{ step.id }}" data-id="{{ f.id }}">‚úï</button>
                  </div>
                {% endfor %}
              </div>
              <div class="mt-2 flex gap-2">
                <input type="file" accept="application/pdf,.pdf,.dwg,.idw" class="hidden" data-upload-pdf-step="{{ step.id }}" />
                <button type="button" class="btn btn-sm" data-open-pdf-upload="{{ step.id }}">Add Document</button>
              </div>
            </div>

            <!-- Images -->
            <div class="mt-3 img-section">
              <div class="text-sm opacity-70 mb-1">Screenshots (paste or drop images)</div>
              <div class="grid grid-cols-2 md:grid-cols-3 gap-2" id="imgs-{{ step.id }}" data-step-id="{{ step.id }}">
                {% for img in step.images.all %}
                  <div class="relative group draggable-img" data-img-id="{{ img.id }}" data-order="{{ img.order }}" draggable="true">
                    <img src="{{ img.image.url }}" class="rounded border object-cover w-full h-28" />
                    <button class="btn btn-xs btn-error absolute top-1 right-1 opacity-0 group-hover:opacity-100 delete-img" data-step="{{ step.id }}" data-id="{{ img.id }}">‚úï</button>
                    <div class="absolute top-1 left-1 bg-black bg-opacity-50 text-white text-xs px-1 rounded opacity-0 group-hover:opacity-100">{{ img.order }}</div>
                  </div>
                {% endfor %}
              </div>
              <div class="mt-2 flex gap-2">
                <button type="button" class="btn btn-sm" data-open-upload="{{ step.id }}">Add images</button>
                <input type="file" accept="image/*" multiple class="hidden" data-upload-step="{{ step.id }}" />
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>

  <div class="col-span-12">
    <h2 class="font-semibold mb-2">Notes</h2>
    <textarea id="process-notes" class="textarea textarea-bordered w-full min-h-40 auto-resize" placeholder="Any notes">{{ process.notes }}</textarea>
  </div>

  <div class="col-span-12">
    <div class="card bg-base-200 shadow-sm">
      <div class="card-body p-4">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="mb-4">
            <label class="label">
              <span class="label-text font-medium">Analysis Instructions</span>
            </label>
            <textarea id="analysis-instructions" class="textarea textarea-bordered w-full min-h-32 auto-resize" placeholder="Instructions for AI analysis">{{ process.analysis_instructions }}</textarea>
          </div>
          
          <div>
            <label class="label">
              <span class="label-text font-medium">Analysis Results</span>
            </label>
            <textarea id="process-analysis" class="textarea textarea-bordered w-full min-h-40 auto-resize" placeholder="AI-generated analysis and improvement suggestions">{{ process.analysis }}</textarea>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modals -->
<dialog id="link-modal" class="modal">
  <div class="modal-box">
    <h3 class="font-bold text-lg mb-4">Add Link</h3>
    <div class="form-control mb-4">
      <label class="label"><span class="label-text">Title</span></label>
      <input id="link-title" class="input input-bordered" placeholder="Link title" />
    </div>
    <div class="form-control mb-4">
      <label class="label"><span class="label-text">URL</span></label>
      <input id="link-url" class="input input-bordered" placeholder="https://example.com" />
    </div>
    <div class="modal-action">
      <button id="link-cancel" class="btn btn-ghost">Cancel</button>
      <button id="link-save" class="btn btn-primary">Add Link</button>
    </div>
  </div>
</dialog>

<!-- Stats Modal -->
<dialog id="stats-modal" class="modal">
  <div class="modal-box w-11/12 max-w-2xl">
    <div class="flex items-center justify-between mb-6">
      <h3 class="font-bold text-2xl text-primary">üìä Process Statistics</h3>
      <button class="btn btn-sm btn-circle btn-ghost" onclick="document.getElementById('stats-modal').close()">‚úï</button>
    </div>
    <div id="stats-content" class="space-y-4">
      <!-- Stats will be loaded here -->
    </div>
  </div>
</dialog>

<!-- Image Viewer Modal -->
<dialog id="image-modal" class="modal">
  <div class="modal-box w-screen h-screen max-w-none max-h-none p-0 bg-base-100 relative">
    <button class="btn btn-sm btn-circle btn-ghost absolute right-3 top-3 z-20" onclick="document.getElementById('image-modal').close()">‚úï</button>
    <div id="zoom-stage" class="w-full h-full overflow-hidden bg-base-100">
      <img id="modal-image" src="" alt="Full size image" class="select-none cursor-move will-change-transform" style="width:100%; height:100%; object-fit: contain; transform: translate(0px,0px) scale(1);" />
    </div>
  </div>
</dialog>
{% endblock %}

{% block extra_js %}
<script>
const processId = {{ process.id }};
const base = '/process-creator/' + processId + '/';

async function post(url, data){
  const form = new URLSearchParams();
  for(const [k,v] of Object.entries(data||{})) form.append(k,v);
  const res = await fetch(url, {method:'POST', headers:{'X-CSRFToken': getCookie('csrftoken')}, body:form});
  return res.json();
}

// Process name update
document.getElementById('process-name').addEventListener('change', (e) => {
  post(base + 'update/', {name: e.target.value});
});

// Process module update
document.getElementById('process-module').addEventListener('change', (e) => {
  post(base + 'update/', {module: e.target.value});
});

// Process description update
document.getElementById('process-description').addEventListener('input', (e) => {
  clearTimeout(e.target._t);
  e.target._t = setTimeout(() => {
    post(base + 'update/', {description: e.target.value});
  }, 400);
});

// Process notes update
document.getElementById('process-notes').addEventListener('input', (e) => {
  clearTimeout(e.target._t);
  e.target._t = setTimeout(() => {
    post(base + 'update/', {notes: e.target.value});
  }, 400);
});

// Summary update
document.getElementById('process-summary').addEventListener('input', (e) => {
  clearTimeout(e.target._t);
  e.target._t = setTimeout(() => {
    post(base + 'update/', {summary: e.target.value});
  }, 400);
});

// Analysis update
document.getElementById('process-analysis').addEventListener('input', (e) => {
  clearTimeout(e.target._t);
  e.target._t = setTimeout(() => {
    post(base + 'update/', {analysis: e.target.value});
  }, 400);
});

// Summary instructions update
document.getElementById('summary-instructions').addEventListener('input', (e) => {
  clearTimeout(e.target._t);
  e.target._t = setTimeout(() => {
    post(base + 'update/', {summary_instructions: e.target.value});
  }, 400);
});

// Analysis instructions update
document.getElementById('analysis-instructions').addEventListener('input', (e) => {
  clearTimeout(e.target._t);
  e.target._t = setTimeout(() => {
    post(base + 'update/', {analysis_instructions: e.target.value});
  }, 400);
});

// Add step
document.getElementById('add-step').addEventListener('click', async () => {
  const data = await post(base + 'steps/add/', {title: 'New Step'});
  location.reload();
});

// Update step fields
document.querySelectorAll('#steps .card').forEach(card => {
  const id = card.dataset.id;
  card.querySelector('.step-title').addEventListener('change', e => {
    post(base + 'steps/' + id + '/update/', {title: e.target.value});
  });
  card.querySelector('.step-details').addEventListener('input', () => {
    clearTimeout(card._t); card._t = setTimeout(() => {
      post(base + 'steps/' + id + '/update/', {details: card.querySelector('.step-details').value});
    }, 400);
  });
  card.querySelector('.step-delete').addEventListener('click', () => {
    post(base + 'steps/' + id + '/delete/').then(() => location.reload());
  });
});

// Stats modal functionality
document.getElementById('stats-btn').addEventListener('click', async (e) => {
  e.preventDefault();
  const modal = document.getElementById('stats-modal');
  const content = document.getElementById('stats-content');
  
  try {
    const res = await fetch(`/process-creator/${processId}/stats/`);
    const data = await res.json();
    
    content.innerHTML = `
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="card bg-base-200 shadow-sm">
          <div class="card-body p-4">
            <h4 class="card-title text-lg text-primary mb-4">üìÖ Timeline</h4>
            <div class="space-y-3">
              <div class="flex items-center gap-3">
                <div class="badge badge-primary badge-sm">Created</div>
                <div class="text-sm font-medium">${data.created_at}</div>
              </div>
              <div class="flex items-center gap-3">
                <div class="badge badge-secondary badge-sm">Updated</div>
                <div class="text-sm font-medium">${data.updated_at}</div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="card bg-base-200 shadow-sm">
          <div class="card-body p-4">
            <h4 class="card-title text-lg text-accent mb-4">üìù Content</h4>
            <div class="space-y-3">
              <div class="flex justify-between items-center">
                <span class="text-sm opacity-70">Steps</span>
                <div class="badge badge-accent badge-lg">${data.step_count}</div>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-sm opacity-70">Substeps</span>
                <div class="badge badge-secondary badge-lg">${data.substep_count || 0}</div>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-sm opacity-70">Total Steps</span>
                <div class="badge badge-primary badge-lg">${data.total_steps || data.step_count}</div>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-sm opacity-70">Images</span>
                <div class="badge badge-accent badge-lg">${data.image_count}</div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="card bg-base-200 shadow-sm">
          <div class="card-body p-4">
            <h4 class="card-title text-lg text-info mb-4">üìÑ Text Content</h4>
            <div class="space-y-3">
              <div class="flex justify-between items-center">
                <span class="text-sm opacity-70">Description</span>
                <div class="text-sm font-medium">${data.description_length || 0} chars</div>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-sm opacity-70">Notes</span>
                <div class="text-sm font-medium">${data.notes_length || 0} chars</div>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-sm opacity-70">Summary</span>
                <div class="text-sm font-medium">${data.summary_length || 0} chars</div>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-sm opacity-70">Analysis</span>
                <div class="text-sm font-medium">${data.analysis_length || 0} chars</div>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-sm opacity-70">Step Details</span>
                <div class="text-sm font-medium">${data.step_details_length || 0} chars</div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="card bg-gradient-to-br from-primary to-secondary text-primary-content shadow-lg">
          <div class="card-body p-4">
            <h4 class="card-title text-lg mb-4">üéØ Summary</h4>
            <div class="space-y-2">
              <div class="flex justify-between">
                <span class="text-sm opacity-90">Total Content</span>
                <span class="font-bold">${(data.total_steps || data.step_count) + data.image_count} items</span>
              </div>
              <div class="flex justify-between">
                <span class="text-sm opacity-90">Text Length</span>
                <span class="font-bold">${data.total_text_length || 0} chars</span>
              </div>
              <div class="divider my-2"></div>
              <div class="text-center">
                <div class="text-2xl font-bold">${(data.total_steps || data.step_count) > 0 ? Math.round(data.image_count / (data.total_steps || data.step_count) * 10) / 10 : 0}</div>
                <div class="text-sm opacity-90">images per step</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
    
    modal.showModal();
  } catch(err) {
    content.innerHTML = `
      <div class="alert alert-error">
        <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <span>Error loading statistics</span>
      </div>
    `;
    modal.showModal();
  }
});

// Image drag and drop reordering
let draggedImg = null;

document.addEventListener('dragstart', (e) => {
  if (e.target.closest('.draggable-img')) {
    draggedImg = e.target.closest('.draggable-img');
    e.target.style.opacity = '0.5';
  }
});

document.addEventListener('dragend', (e) => {
  if (e.target.closest('.draggable-img')) {
    e.target.style.opacity = '';
    draggedImg = null;
  }
});

document.addEventListener('dragover', (e) => {
  e.preventDefault();
  const imgContainer = e.target.closest('.draggable-img');
  if (imgContainer && draggedImg && imgContainer !== draggedImg) {
    const container = imgContainer.parentElement;
    const afterElement = getDragAfterElement(container, e.clientY);
    if (afterElement == null) {
      container.appendChild(draggedImg);
    } else {
      container.insertBefore(draggedImg, afterElement);
    }
  }
});

document.addEventListener('drop', async (e) => {
  e.preventDefault();
  if (draggedImg) {
    const container = draggedImg.parentElement;
    const stepId = container.getAttribute('data-step-id');
    const imgIds = Array.from(container.querySelectorAll('.draggable-img')).map(img => img.getAttribute('data-img-id'));
    
    try {
      const formData = new FormData();
      imgIds.forEach(id => formData.append('order[]', id));
      const res = await fetch(base + 'steps/' + stepId + '/images/reorder/', {
        method: 'POST',
        headers: { 'X-CSRFToken': getCookie('csrftoken') },
        body: formData
      });
      if (res.ok) {
        // Update order numbers in UI
        imgIds.forEach((id, index) => {
          const img = container.querySelector(`[data-img-id="${id}"]`);
          if (img) {
            img.setAttribute('data-order', index + 1);
            const orderDiv = img.querySelector('.absolute.top-1.left-1');
            if (orderDiv) orderDiv.textContent = index + 1;
          }
        });
      }
    } catch (err) {
      console.error('Failed to reorder images:', err);
    }
  }
});

function getDragAfterElement(container, y) {
  const draggableElements = [...container.querySelectorAll('.draggable-img:not(.dragging)')];
  return draggableElements.reduce((closest, child) => {
    const box = child.getBoundingClientRect();
    const offset = y - box.top - box.height / 2;
    if (offset < 0 && offset > closest.offset) {
      return { offset: offset, element: child };
    } else {
      return closest;
    }
  }, { offset: Number.NEGATIVE_INFINITY }).element;
}
</script>
{% endblock %}
