{% extends 'process_creator/base.html' %}
{% block title %}Process Creator{% endblock %}
{% block content %}
<div class="flex items-center justify-between mb-6">
  <h1 class="text-2xl font-bold">Process Creator</h1>
  <div class="flex gap-2">
    <a href="{% url 'process_creator:create' %}" class="btn btn-primary">New Process</a>
  </div>
</div>

<!-- Module Filter -->
<div class="mb-6">
  <div class="flex items-center gap-4">
    <label for="module-filter" class="text-sm font-medium">Filter by Module:</label>
    <select id="module-filter" class="select select-bordered w-full max-w-xs">
      <option value="">All Modules</option>
      {% for module in modules %}
        <option value="{{ module.id }}" {% if selected_module and selected_module.id == module.id %}selected{% endif %}>
          {{ module.name }}
        </option>
      {% endfor %}
      <option value="__new__">+ New Module‚Ä¶</option>
    </select>
    {% if selected_module %}
      <div class="text-sm text-base-content/70">
        Showing processes in: <strong>{{ selected_module.name }}</strong>
      </div>
    {% endif %}
  </div>
</div>

<div id="process-list" class="grid gap-3">
  {% for p in processes %}
    <div class="card bg-base-200 shadow-sm" data-id="{{ p.id }}">
      <div class="card-body py-3 px-4">
        <div class="flex items-center justify-between gap-3">
          <div class="flex items-center gap-3">
            <div>
              <h3 class="font-semibold text-lg">{{ p.name }}</h3>
              {% if p.module %}
                <div class="badge badge-outline badge-sm">{{ p.module.name }}</div>
              {% endif %}
              <div class="text-sm text-base-content/70 mt-1">
                {{ p.steps.count }} steps ‚Ä¢ Updated {{ p.updated_at|date:"M j, Y" }}
              </div>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <a href="{% url 'process_creator:edit' p.id %}" class="btn btn-sm btn-primary">Edit</a>
            <div class="dropdown dropdown-end">
              <div tabindex="0" role="button" class="btn btn-sm btn-ghost">
                <i class="fas fa-ellipsis-v"></i>
              </div>
              <ul tabindex="0" class="dropdown-content menu p-2 shadow bg-base-100 rounded-box w-52">
                <li><a href="{% url 'process_creator:pdf' p.id %}"><i class="fas fa-file-pdf mr-2"></i>Export PDF</a></li>
                <li><a href="{% url 'process_creator:word' p.id %}"><i class="fas fa-file-word mr-2"></i>Export Word</a></li>
                <li><a href="{% url 'process_creator:stats' p.id %}" class="stats-link"><i class="fas fa-chart-bar mr-2"></i>Statistics</a></li>
                <li><a href="{% url 'process_creator:delete' p.id %}" class="text-error delete-process"><i class="fas fa-trash mr-2"></i>Delete</a></li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  {% empty %}
    <div class="text-center py-12">
      <i class="fas fa-cogs text-6xl text-base-content/30 mb-4"></i>
      <h3 class="text-xl font-semibold mb-2">No processes yet</h3>
      <p class="text-base-content/70 mb-4">Create your first process to get started</p>
      <a href="{% url 'process_creator:create' %}" class="btn btn-primary">Create Process</a>
    </div>
  {% endfor %}
</div>

<!-- New Module Modal -->
<dialog id="new-module-modal" class="modal">
  <div class="modal-box">
    <h3 class="font-bold text-lg mb-4">Create New Module</h3>
    <div class="form-control mb-4">
      <label class="label"><span class="label-text">Name</span></label>
      <input id="new-module-name" class="input input-bordered" placeholder="e.g., Engineering/Drafting" />
    </div>
    <div class="form-control mb-4">
      <label class="label"><span class="label-text">Description (optional)</span></label>
      <textarea id="new-module-desc" class="textarea textarea-bordered auto-resize" rows="3" placeholder="Short description"></textarea>
    </div>
    <div class="modal-action">
      <button id="create-module-cancel" class="btn btn-ghost">Cancel</button>
      <button id="create-module-save" class="btn btn-primary">Create</button>
    </div>
  </div>
</dialog>

<!-- Stats Modal -->
<dialog id="stats-modal" class="modal">
  <div class="modal-box w-11/12 max-w-2xl">
    <div class="flex items-center justify-between mb-6">
      <h3 class="font-bold text-2xl text-primary">üìä Process Statistics</h3>
      <button class="btn btn-sm btn-circle btn-ghost" onclick="document.getElementById('stats-modal').close()">‚úï</button>
    </div>
    <div id="stats-content" class="space-y-4">
      <!-- Stats will be loaded here -->
    </div>
  </div>
</dialog>
{% endblock %}

{% block extra_js %}
<script>
// Module filter
document.getElementById('module-filter').addEventListener('change', function() {
  const value = this.value;
  if (value === '__new__') {
    document.getElementById('new-module-modal').showModal();
    this.value = '';
  } else if (value) {
    window.location.href = `?module=${value}`;
  } else {
    window.location.href = window.location.pathname;
  }
});

// New module creation
document.getElementById('create-module-cancel').addEventListener('click', () => {
  document.getElementById('new-module-modal').close();
});

document.getElementById('create-module-save').addEventListener('click', async () => {
  const name = document.getElementById('new-module-name').value.trim();
  const description = document.getElementById('new-module-desc').value.trim();
  
  if (!name) {
    showToast('Module name is required', 'error');
    return;
  }
  
  try {
    const response = await fetch('{% url "process_creator:module_create" %}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify({ name, description })
    });
    
    const data = await response.json();
    
    if (data.ok) {
      showToast('Module created successfully', 'success');
      document.getElementById('new-module-modal').close();
      document.getElementById('new-module-name').value = '';
      document.getElementById('new-module-desc').value = '';
      // Reload page to show new module
      location.reload();
    } else {
      showToast(data.error || 'Failed to create module', 'error');
    }
  } catch (error) {
    showToast('Error creating module', 'error');
  }
});

// Process deletion
document.querySelectorAll('.delete-process').forEach(link => {
  link.addEventListener('click', async (e) => {
    e.preventDefault();
    if (!confirm('Are you sure you want to delete this process?')) return;
    
    try {
      const response = await fetch(link.href, {
        method: 'POST',
        headers: { 'X-CSRFToken': getCookie('csrftoken') }
      });
      
      if (response.ok) {
        showToast('Process deleted successfully', 'success');
        link.closest('.card').remove();
      } else {
        showToast('Failed to delete process', 'error');
      }
    } catch (error) {
      showToast('Error deleting process', 'error');
    }
  });
});

// Stats modal
document.querySelectorAll('.stats-link').forEach(link => {
  link.addEventListener('click', async (e) => {
    e.preventDefault();
    const processId = link.closest('.card').dataset.id;
    
    try {
      const response = await fetch(`/process-creator/${processId}/stats/`);
      const data = await response.json();
      
      document.getElementById('stats-content').innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="card bg-base-200 shadow-sm">
            <div class="card-body p-4">
              <h4 class="card-title text-lg text-primary mb-4">üìÖ Timeline</h4>
              <div class="space-y-3">
                <div class="flex items-center gap-3">
                  <div class="badge badge-primary badge-sm">Created</div>
                  <div class="text-sm font-medium">${data.created_at}</div>
                </div>
                <div class="flex items-center gap-3">
                  <div class="badge badge-secondary badge-sm">Updated</div>
                  <div class="text-sm font-medium">${data.updated_at}</div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="card bg-base-200 shadow-sm">
            <div class="card-body p-4">
              <h4 class="card-title text-lg text-accent mb-4">üìù Content</h4>
              <div class="space-y-3">
                <div class="flex justify-between items-center">
                  <span class="text-sm opacity-70">Steps</span>
                  <div class="badge badge-accent badge-lg">${data.step_count}</div>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-sm opacity-70">Substeps</span>
                  <div class="badge badge-secondary badge-lg">${data.substep_count || 0}</div>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-sm opacity-70">Total Steps</span>
                  <div class="badge badge-primary badge-lg">${data.total_steps || data.step_count}</div>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-sm opacity-70">Images</span>
                  <div class="badge badge-accent badge-lg">${data.image_count}</div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="card bg-base-200 shadow-sm">
            <div class="card-body p-4">
              <h4 class="card-title text-lg text-info mb-4">üìÑ Text Content</h4>
              <div class="space-y-3">
                <div class="flex justify-between items-center">
                  <span class="text-sm opacity-70">Description</span>
                  <div class="text-sm font-medium">${data.description_length || 0} chars</div>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-sm opacity-70">Notes</span>
                  <div class="text-sm font-medium">${data.notes_length || 0} chars</div>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-sm opacity-70">Summary</span>
                  <div class="text-sm font-medium">${data.summary_length || 0} chars</div>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-sm opacity-70">Analysis</span>
                  <div class="text-sm font-medium">${data.analysis_length || 0} chars</div>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-sm opacity-70">Step Details</span>
                  <div class="text-sm font-medium">${data.step_details_length || 0} chars</div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="card bg-gradient-to-br from-primary to-secondary text-primary-content shadow-lg">
            <div class="card-body p-4">
              <h4 class="card-title text-lg mb-4">üéØ Summary</h4>
              <div class="space-y-2">
                <div class="flex justify-between">
                  <span class="text-sm opacity-90">Total Content</span>
                  <span class="font-bold">${(data.total_steps || data.step_count) + data.image_count} items</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-sm opacity-90">Text Length</span>
                  <span class="font-bold">${data.total_text_length || 0} chars</span>
                </div>
                <div class="divider my-2"></div>
                <div class="text-center">
                  <div class="text-2xl font-bold">${(data.total_steps || data.step_count) > 0 ? Math.round(data.image_count / (data.total_steps || data.step_count) * 10) / 10 : 0}</div>
                  <div class="text-sm opacity-90">images per step</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
      
      document.getElementById('stats-modal').showModal();
    } catch (error) {
      showToast('Error loading statistics', 'error');
    }
  });
});
</script>
{% endblock %}
